<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>R2BEAT two-stage sampling design workflow starting from the sampling frame • R2BEAT </title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="R2BEAT two-stage sampling design workflow starting from the sampling frame">
<meta property="og:description" content="R2BEAT ">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-156656860-1"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-156656860-1');
</script>
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">R2BEAT </a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.0.3</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/R2BEAT_methodology.html">R2BEAT methodology and use</a>
    </li>
    <li>
      <a href="../articles/R2BEAT_workflow.html">R2BEAT two-stage sampling design workflow</a>
    </li>
    <li>
      <a href="../articles/R2BEAT_workflow_from_frame.html">R2BEAT two-stage sampling design workflow starting from the sampling frame</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/barcaroli/R2BEAT/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="R2BEAT_workflow_from_frame_files/header-attrs-2.5/header-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>R2BEAT two-stage sampling design workflow starting from the sampling frame</h1>
            
            <h4 class="date">2021-01-27 <br><br><br>
</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/barcaroli/R2BEAT/blob/master/vignettes/R2BEAT_workflow_from_frame.Rmd"><code>vignettes/R2BEAT_workflow_from_frame.Rmd</code></a></small>
      <div class="hidden name"><code>R2BEAT_workflow_from_frame.Rmd</code></div>

    </div>

    
    
<p>This vignette describes a generalized procedure making use of the methods implemented in the R package developed in the Italian National Institute, namely R2BEAT (“Multistage Sampling Allocation and PSU selection”).</p>
<p>This package allows to determine the optimal allocation of both Primary Stage Units (PSUs) and Secondary Stage Units (SSU), and also to perform a selection of the PSUs such that the final sample of SSU is of the self-weighting type, i.e. the total inclusion probabilities (as resulting from the product between the inclusion probabilities of the PSUs and those of the SSUs) are near equal for all SSUs, or at least those of minimum variability.</p>
<p>This general flow assumes that a sampling frame is available, containing, among the others, the following variables:</p>
<ul>
<li>identifier of the Primary Sampling Units;</li>
<li>identifier of the Secondary Sampling Units;</li>
<li>variables identifying the sampling strata;</li>
<li>target variables, i.e. the variables from which sampling estimates will be produced.</li>
</ul>
<p>As for the last type of variables, of course their direct availability is not possible: instead, proxy variables will be present in the sampling frame, or the same variables with predicted values.</p>
<p>Having this sampling frame, the workflow is based on the following steps:</p>
<ol style="list-style-type: decimal">
<li>Loading data and pre-processing</li>
<li>Producing the inputs for next steps</li>
<li>Optimal allocation of SSUs in PSUs</li>
<li>Selection of PSUs</li>
<li>Selection of SSUs</li>
</ol>
<div id="loading-data-and-pre-processing" class="section level1">
<h1 class="hasAnchor">
<a href="#loading-data-and-pre-processing" class="anchor"></a>Loading data and pre-processing</h1>
<p>We make use of a synthetic population data frame:</p>
<div class="sourceCode" id="cb1"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/load.html">load</a></span>(<span class="st">"Frame.RData"</span>)   
<span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span>(<span class="kw">pop</span>)
</pre></div>
<pre><code>## 'data.frame':    2258507 obs. of  21 variables:
##  $ region       : Factor w/ 3 levels "north","center",..: 1 1 1 1 1 1 1 1 1 1 ...
##  $ province     : Factor w/ 6 levels "north_1","north_2",..: 1 1 1 1 1 1 1 1 1 1 ...
##  $ municipality : num  1 1 1 1 1 1 1 1 1 1 ...
##  $ pop_m        : num  1546 1546 1546 1546 1546 ...
##  $ type_m       : num  6 6 6 6 6 6 6 6 6 6 ...
##  $ id_hh        : Factor w/ 963018 levels "H1","H10","H100",..: 1 1 1 2 3 3 3 3 1114 1114 ...
##  $ id_ind       : int  1 2 3 4 5 6 7 8 9 10 ...
##  $ sex          : int  1 2 1 2 1 1 2 2 1 1 ...
##  $ age          : int  33 69 81 46 38 64 63 35 37 6 ...
##  $ edu          : int  5 3 3 4 5 3 4 12 5 2 ...
##  $ marital      : num  1 2 2 1 1 2 2 2 1 1 ...
##  $ foreigner    : int  0 0 0 0 0 0 0 0 0 0 ...
##  $ earner       : int  1 1 1 1 1 1 1 1 1 0 ...
##  $ income_hh    : num  30488 30488 30488 21756 29871 ...
##  $ work         : num  1 1 2 1 1 1 1 1 1 2 ...
##  $ unemployed   : num  0 0 0 0 0 0 0 0 0 0 ...
##  $ one          : num  1 1 1 1 1 1 1 1 1 1 ...
##  $ stratum      : Factor w/ 24 levels "1000","2000",..: 12 12 12 12 12 12 12 12 12 12 ...
##  $ stratum_n    : num  12000 12000 12000 12000 12000 12000 12000 12000 12000 12000 ...
##  $ stratum_label: chr  "north_1_6" "north_1_6" "north_1_6" "north_1_6" ...
##  $ prog_hh      : int  1 2 3 1 1 2 3 4 1 2 ...</code></pre>
<p>In this phase we may have to derive new variables, corresponding to the parameters required by the following steps. In this case, it is not necessary, as almost all the variables are already available. We just have We manipulate in order to derive two target (binary) variables, and add a work variable (‘one’):</p>
<div class="sourceCode" id="cb3"><pre class="downlit">
<span class="kw">pop</span><span class="op">$</span><span class="kw">active</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(<span class="kw">pop</span><span class="op">$</span><span class="kw">work</span><span class="op">==</span><span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">0</span>)
<span class="kw">pop</span><span class="op">$</span><span class="kw">inactive</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(<span class="kw">pop</span><span class="op">$</span><span class="kw">work</span><span class="op">==</span><span class="fl">2</span>,<span class="fl">1</span>,<span class="fl">0</span>)
<span class="kw">pop</span><span class="op">$</span><span class="kw">one</span> <span class="op">&lt;-</span> <span class="fl">1</span>
</pre></div>
<p>Great attention must be paid to the nature of the target variables, especially of the ‘factor’ type. In fact, the procedure here illustrated is suitable only when categorical variables are binary with values 0 and 1, supposing we are willing to estimate proportions of ‘1’ in the population. If factor variables are of other nature, then an error message is printed.</p>
<p>Therefore, we have to handle the ‘work’ variable in this way: as values 0, 1 and 2 indicate respectively non labour force, active and inactive people, this is why we derived from ‘work’ the two binary variables, ‘active’ and ‘inactive’.</p>
<p>We are now able to populate the required parameters:</p>
<div class="sourceCode" id="cb4"><pre class="downlit">
<span class="kw">samp_frame</span> <span class="op">&lt;-</span> <span class="kw">pop</span>
<span class="kw">id_PSU</span> <span class="op">&lt;-</span> <span class="st">"municipality"</span>  <span class="co"># only one</span>
<span class="kw">id_SSU</span> <span class="op">&lt;-</span> <span class="st">"id_ind"</span>        <span class="co"># only one</span>
<span class="kw">strata_var</span> <span class="op">&lt;-</span> <span class="st">"stratum"</span>   <span class="co"># only one</span>
<span class="kw">target_vars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"income_hh"</span>,<span class="st">"active"</span>,<span class="st">"inactive"</span>,<span class="st">"unemployed"</span>)   <span class="co"># more than one</span>
<span class="kw">deff_var</span> <span class="op">&lt;-</span> <span class="st">"stratum"</span>     <span class="co"># only one</span>
<span class="kw">domain_var</span> <span class="op">&lt;-</span> <span class="st">"region"</span>    <span class="co"># only one</span>
<span class="kw">minimum</span> <span class="op">&lt;-</span> <span class="fl">50</span>  <span class="co"># minimum number of SSUs to be interviewed in each selected PSU</span>
<span class="kw">delta</span> <span class="op">=</span>  <span class="fl">1</span>     <span class="co"># average dimension of the SSU in terms of elementary survey units</span>
<span class="kw">f</span> <span class="op">=</span> <span class="fl">0.05</span>          <span class="co"># suggestion for the sampling fraction </span>
<span class="kw">deff_sugg</span> <span class="op">&lt;-</span> <span class="fl">1.5</span>  <span class="co"># suggestion for the deff value</span>
</pre></div>
</div>
<div id="producing-the-inputs-for-next-steps" class="section level1">
<h1 class="hasAnchor">
<a href="#producing-the-inputs-for-next-steps" class="anchor"></a>Producing the inputs for next steps</h1>
<p>With already assigned parameters, we can execute the ‘prepareInputToAllocation’ function:</p>
<div class="sourceCode" id="cb5"><pre class="downlit">
<span class="kw">inp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/prepareInputToAllocation.html">prepareInputToAllocation</a></span>(<span class="kw">samp_frame</span>,
                                <span class="kw">id_PSU</span>,
                                <span class="kw">id_SSU</span>,
                                <span class="kw">strata_var</span>,
                                <span class="kw">target_vars</span>,
                                <span class="kw">deff_var</span>,
                                <span class="kw">domain_var</span>,
                                <span class="kw">minimum</span>,
                                <span class="kw">delta</span>,
                                <span class="kw">f</span>,
                                <span class="kw">deff_sugg</span>)
</pre></div>
<p>The function ‘prepareInputToAllocation’ produces a list composed by six elements, stored in the ‘inp’ object:</p>
<ol style="list-style-type: lower-alpha">
<li>the ‘stratif’ dataframe containing:</li>
</ol>
<ul>
<li>STRATUM: identifier of the single stratum</li>
<li>N: total population in terms of final sampling units</li>
<li>Mi,Si: mean and standard deviation of target variables (i=1,2,..,P)</li>
<li>DOMk: domain(s) to which the stratum belongs</li>
</ul>
<ol start="2" style="list-style-type: lower-alpha">
<li>the ‘deff’ (design effect) dataframe, containing the following information:</li>
</ol>
<ul>
<li>STRATUM: the stratum identifier</li>
<li>DEFFi: the design effect for each target variable i (i=1,2,…,P)</li>
</ul>
<ol start="3" style="list-style-type: lower-alpha">
<li>the ‘effst’ (estimator effect) dataframe, containing the following information:</li>
</ol>
<ul>
<li>STRATUM: the stratum identifier</li>
<li>EFFSTi: the estimator effect for each target variable i (i=1,2,…,P)</li>
</ul>
<ol start="4" style="list-style-type: lower-alpha">
<li>the ‘rho’ (intraclass coefficient of correlation) dataframe, containing the following information:</li>
</ol>
<ul>
<li>STRATUM: the stratum identifier</li>
<li>RHO_ARi: the intraclass coefficient of correlation in self-representative PSUs for each target variable i (i=1,2,…,P)</li>
<li>RHO_NARi: the intraclass coefficient of correlation in non self-representative PSUs for each target variable i (i=1,2,…,P)</li>
</ul>
<ol start="5" style="list-style-type: lower-alpha">
<li>the ‘des_file’ dataframe, containing the following information:</li>
</ol>
<ul>
<li>STRATUM: stratum identifier</li>
<li>MOS: measure of size of the stratum (in terms of number of contained selection units)</li>
<li>DELTA: factor that report the average number of SSUs for each selection unit</li>
<li>MINIMUM: minimum number of units to be selected in each PSU</li>
</ul>
<ol start="6" style="list-style-type: lower-alpha">
<li>the ‘PSU_file’ dataframe, containing the following information:</li>
</ol>
<ul>
<li>stratum identifier</li>
<li>PSU id</li>
<li>PSU_MOS: number of final selection units contained in a given PSU</li>
</ul>
<p>(Actually, the ‘deff’ dataframe is not used in the following steps, it just remains for documentation purposes.)</p>
<p>Let us see the content of these objects:</p>
<div class="sourceCode" id="cb6"><pre class="downlit">
<span class="kw">inp</span><span class="op">$</span><span class="kw">strata</span>
</pre></div>
<div class="sourceCode" id="cb7"><pre class="downlit">
<span class="kw">inp</span><span class="op">$</span><span class="kw">deff</span>
</pre></div>
<pre><code>##    STRATUM DEFF1 DEFF2 DEFF3 DEFF4      b_nar
## 1     1000   1.5   1.5   1.5   1.5 4925.17500
## 12    2000   1.5   1.5   1.5   1.5 1005.60000
## 18    3000   1.5   1.5   1.5   1.5  222.71731
## 19    4000   1.5   1.5   1.5   1.5   47.89167
## 20    5000   1.5   1.5   1.5   1.5 2526.67500
## 21    6000   1.5   1.5   1.5   1.5  786.96667
## 22    7000   1.5   1.5   1.5   1.5  168.72222
## 23    8000   1.5   1.5   1.5   1.5   69.78421
## 24    9000   1.5   1.5   1.5   1.5 4641.65000
## 2    10000   1.5   1.5   1.5   1.5  883.58333
## 3    11000   1.5   1.5   1.5   1.5  174.49153
## 4    12000   1.5   1.5   1.5   1.5   57.65700
## 5    13000   1.5   1.5   1.5   1.5 5146.65000
## 6    14000   1.5   1.5   1.5   1.5 1049.78750
## 7    15000   1.5   1.5   1.5   1.5  194.15625
## 8    16000   1.5   1.5   1.5   1.5   44.59672
## 9    17000   1.5   1.5   1.5   1.5 3055.85000
## 10   18000   1.5   1.5   1.5   1.5  618.79167
## 11   19000   1.5   1.5   1.5   1.5  189.70676
## 13   20000   1.5   1.5   1.5   1.5   55.32091
## 14   21000   1.5   1.5   1.5   1.5 2757.20000
## 15   22000   1.5   1.5   1.5   1.5  696.51667
## 16   23000   1.5   1.5   1.5   1.5  240.55000
## 17   24000   1.5   1.5   1.5   1.5   48.19583</code></pre>
<div class="sourceCode" id="cb9"><pre class="downlit">
<span class="kw">inp</span><span class="op">$</span><span class="kw">effst</span>
</pre></div>
<pre><code>##    STRATUM EFFST1 EFFST2 EFFST3 EFFST4
## 1     1000      1      1      1      1
## 2     2000      1      1      1      1
## 3     3000      1      1      1      1
## 4     4000      1      1      1      1
## 5     5000      1      1      1      1
## 6     6000      1      1      1      1
## 7     7000      1      1      1      1
## 8     8000      1      1      1      1
## 9     9000      1      1      1      1
## 10   10000      1      1      1      1
## 11   11000      1      1      1      1
## 12   12000      1      1      1      1
## 13   13000      1      1      1      1
## 14   14000      1      1      1      1
## 15   15000      1      1      1      1
## 16   16000      1      1      1      1
## 17   17000      1      1      1      1
## 18   18000      1      1      1      1
## 19   19000      1      1      1      1
## 20   20000      1      1      1      1
## 21   21000      1      1      1      1
## 22   22000      1      1      1      1
## 23   23000      1      1      1      1
## 24   24000      1      1      1      1</code></pre>
<div class="sourceCode" id="cb11"><pre class="downlit">
<span class="kw">inp</span><span class="op">$</span><span class="kw">rho</span>
</pre></div>
<pre><code>##    STRATUM RHO_AR1      RHO_NAR1 RHO_AR2      RHO_NAR2 RHO_AR3      RHO_NAR3 RHO_AR4      RHO_NAR4
## 1     1000       1 0.00010153985       1 0.00010153985       1 0.00010153985       1 0.00010153985
## 12    2000       1 0.00049771053       1 0.00049771053       1 0.00049771053       1 0.00049771053
## 18    3000       1 0.00225512390       1 0.00225512390       1 0.00225512390       1 0.00225512390
## 19    4000       1 0.01066287542       1 0.01066287542       1 0.01066287542       1 0.01066287542
## 20    5000       1 0.00019796688       1 0.00019796688       1 0.00019796688       1 0.00019796688
## 21    6000       1 0.00063615929       1 0.00063615929       1 0.00063615929       1 0.00063615929
## 22    7000       1 0.00298111958       1 0.00298111958       1 0.00298111958       1 0.00298111958
## 23    8000       1 0.00726911011       1 0.00726911011       1 0.00726911011       1 0.00726911011
## 24    9000       1 0.00010774353       1 0.00010774353       1 0.00010774353       1 0.00010774353
## 2    10000       1 0.00056651874       1 0.00056651874       1 0.00056651874       1 0.00056651874
## 3    11000       1 0.00288198515       1 0.00288198515       1 0.00288198515       1 0.00288198515
## 4    12000       1 0.00882503486       1 0.00882503486       1 0.00882503486       1 0.00882503486
## 5    13000       1 0.00009716945       1 0.00009716945       1 0.00009716945       1 0.00009716945
## 6    14000       1 0.00047674100       1 0.00047674100       1 0.00047674100       1 0.00047674100
## 7    15000       1 0.00258857790       1 0.00258857790       1 0.00258857790       1 0.00258857790
## 8    16000       1 0.01146875235       1 0.01146875235       1 0.01146875235       1 0.01146875235
## 9    17000       1 0.00016367416       1 0.00016367416       1 0.00016367416       1 0.00016367416
## 10   18000       1 0.00080933432       1 0.00080933432       1 0.00080933432       1 0.00080933432
## 11   19000       1 0.00264961366       1 0.00264961366       1 0.00264961366       1 0.00264961366
## 13   20000       1 0.00920455877       1 0.00920455877       1 0.00920455877       1 0.00920455877
## 14   21000       1 0.00018140919       1 0.00018140919       1 0.00018140919       1 0.00018140919
## 15   22000       1 0.00071889003       1 0.00071889003       1 0.00071889003       1 0.00071889003
## 16   23000       1 0.00208724692       1 0.00208724692       1 0.00208724692       1 0.00208724692
## 17   24000       1 0.01059415556       1 0.01059415556       1 0.01059415556       1 0.01059415556</code></pre>
<div class="sourceCode" id="cb13"><pre class="downlit">
<span class="kw">inp</span><span class="op">$</span><span class="kw">des_file</span>
</pre></div>
<pre><code>##    STRATUM STRAT_MOS DELTA MINIMUM
## 1     1000    197007     1      50
## 2     2000    261456     1      50
## 3     3000    115813     1      50
## 4     4000     17241     1      50
## 5     5000    101067     1      50
## 6     6000     47218     1      50
## 7     7000     30370     1      50
## 8     8000     26518     1      50
## 9     9000     92833     1      50
## 10   10000    106030     1      50
## 11   11000    205900     1      50
## 12   12000     57657     1      50
## 13   13000    102933     1      50
## 14   14000     83983     1      50
## 15   15000    186390     1      50
## 16   16000    108816     1      50
## 17   17000     61117     1      50
## 18   18000     74255     1      50
## 19   19000    140383     1      50
## 20   20000     60853     1      50
## 21   21000     55144     1      50
## 22   22000     41791     1      50
## 23   23000     72165     1      50
## 24   24000     11567     1      50</code></pre>
<div class="sourceCode" id="cb15"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="kw">inp</span><span class="op">$</span><span class="kw">PSU_file</span>)
</pre></div>
<pre><code>## NULL</code></pre>
<p>It may happen that the population in strata (variable ‘N’ in ‘inp$strata’ dataset) and the one derived by the PSU dataset (variable ‘STRAT_MOS’ in ‘inp$des_file’ dataset) are not the same.</p>
<p>We can check it by applying the function ‘check_input’ in this way:</p>
<div class="sourceCode" id="cb17"><pre class="downlit">
<span class="kw">newstrata</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/check_input.html">check_input</a></span>(strata=<span class="kw">inp</span><span class="op">$</span><span class="kw">strata</span>,
                         des=<span class="kw">inp</span><span class="op">$</span><span class="kw">des_file</span>,
                         strata_var_strata=<span class="st">"STRATUM"</span>,
                         strata_var_des=<span class="st">"STRATUM"</span>)
</pre></div>
<pre><code>## 
## --------------------------------------------------
##  Differences between population in strata and PSUs  
## --------------------------------------------------
##    STRATUM N_in_strata N_in_PSUs relative_difference
## 1     1000      197007    197007                   0
## 2    10000      106030    106030                   0
## 3    11000      205900    205900                   0
## 4    12000       57657     57657                   0
## 5    13000      102933    102933                   0
## 6    14000       83983     83983                   0
## 7    15000      186390    186390                   0
## 8    16000      108816    108816                   0
## 9    17000       61117     61117                   0
## 10   18000       74255     74255                   0
## 11   19000      140383    140383                   0
## 12    2000      261456    261456                   0
## 13   20000       60853     60853                   0
## 14   21000       55144     55144                   0
## 15   22000       41791     41791                   0
## 16   23000       72165     72165                   0
## 17   24000       11567     11567                   0
## 18    3000      115813    115813                   0
## 19    4000       17241     17241                   0
## 20    5000      101067    101067                   0
## 21    6000       47218     47218                   0
## 22    7000       30370     30370                   0
## 23    8000       26518     26518                   0
## 24    9000       92833     92833                   0
## 
## --------------------------------------------------
## Population of PSUs has been attributed to strata</code></pre>
</div>
<div id="optimal-allocation" class="section level1">
<h1 class="hasAnchor">
<a href="#optimal-allocation" class="anchor"></a>Optimal allocation</h1>
<p>First, we define the precision constraints:</p>
<div class="sourceCode" id="cb19"><pre class="downlit">
<span class="kw">cv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(DOM=<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"DOM1"</span>,<span class="st">"DOM2"</span>),
                         CV1=<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0.03</span>,<span class="fl">0.04</span>),
                         CV2=<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0.06</span>,<span class="fl">0.08</span>),
                         CV3=<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0.06</span>,<span class="fl">0.08</span>),
                         CV4=<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0.06</span>,<span class="fl">0.08</span>)))
<span class="kw">cv</span>
</pre></div>
<pre><code>##    DOM  CV1  CV2  CV3  CV4
## 1 DOM1 0.03 0.06 0.06 0.06
## 2 DOM2 0.04 0.08 0.08 0.08</code></pre>
<p>The meaning of these constraints is that, once we select a sample and produce extimates, we expect a maximum coefficient of variation for the first variable (‘income_hh’) equal to 3% at national level (‘DOM1’) and to 4% at regional level (‘DOM2’); respectively 6% and 8% for the other three variables.</p>
<p>Using the function ‘beat.2st’ in ‘R2BEAT’ package execute the optimization of PSU and SSU allocation in strata:</p>
<div class="sourceCode" id="cb21"><pre class="downlit">
<span class="kw">alloc</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/beat.2st.html">beat.2st</a></span>(<span class="kw">inp</span><span class="op">$</span><span class="kw">strata</span>, 
                  <span class="kw">cv</span>, 
                  <span class="kw">inp</span><span class="op">$</span><span class="kw">des_file</span>, 
                  <span class="kw">inp</span><span class="op">$</span><span class="kw">psu_file</span>, 
                  <span class="kw">inp</span><span class="op">$</span><span class="kw">rho</span>, 
                  deft_start = <span class="kw">NULL</span>, 
                  <span class="kw">inp</span><span class="op">$</span><span class="kw">effst</span>,
                  epsilon1 = <span class="fl">5</span>, 
                  mmdiff_deft = <span class="fl">1</span>,
                  maxi = <span class="fl">15</span>, 
                  epsilon = <span class="fl">10</span><span class="op">^</span>(<span class="op">-</span><span class="fl">11</span>), 
                  minnumstrat = <span class="fl">2</span>, 
                  maxiter = <span class="fl">200</span>, 
                  maxiter1 = <span class="fl">25</span>)
</pre></div>
<pre><code>##   iterations PSU_SR PSU NSR PSU Total  SSU
## 1          0      0       0         0 7391
## 2          1     20      86       106 8302
## 3          2     21      99       120 8300</code></pre>
<p>This is the sensitivity of the solution:</p>
<div class="sourceCode" id="cb23"><pre class="downlit">
<span class="kw">alloc</span><span class="op">$</span><span class="kw">sensitivity</span>
</pre></div>
<pre><code>##    Type Dom V1 V2  V3   V4
## 1  DOM1   1  1  0   1    1
## 5  DOM2   1  0  0   0 1283
## 9  DOM2   2  1  0   1  247
## 13 DOM2   3  1  1 129    1</code></pre>
<p>i.e., for each domain value and for each variable it is reported the gain in terms of reduction in the sample size if the corresponding precision constraint is reduced of 10%.</p>
<p>These are the expected values of the coefficients of variation:</p>
<div class="sourceCode" id="cb25"><pre class="downlit">
<span class="kw">alloc</span><span class="op">$</span><span class="kw">expected</span>
</pre></div>
<pre><code>##    Type Dom     V1     V2     V3     V4
## 1  DOM1   1 0.0123 0.0109 0.0288 0.0447
## 5  DOM2   1 0.0117 0.0074 0.0260 0.0800
## 9  DOM2   2 0.0256 0.0213 0.0533 0.0799
## 13 DOM2   3 0.0387 0.0438 0.0799 0.0609</code></pre>
</div>
<div id="selection-of-psus" class="section level1">
<h1 class="hasAnchor">
<a href="#selection-of-psus" class="anchor"></a>Selection of PSUs</h1>
<p>Using the function ‘StratSel’ execute the selection of PSU in strata:</p>
<div class="sourceCode" id="cb27"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="fl">1234</span>)
<span class="kw">allocat</span> <span class="op">&lt;-</span> <span class="kw">alloc</span><span class="op">$</span><span class="kw">alloc</span>[<span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="kw">alloc</span><span class="op">$</span><span class="kw">alloc</span>),]
<span class="kw">sample_2st</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/StratSel.html">StratSel</a></span>(dataPop= <span class="kw">inp</span><span class="op">$</span><span class="kw">psu_file</span>,
                       idpsu= <span class="op">~</span> <span class="kw">PSU_ID</span>, 
                       dom= <span class="op">~</span> <span class="kw">STRATUM</span>, 
                       final_pop= <span class="op">~</span> <span class="kw">PSU_MOS</span>, 
                       size= <span class="op">~</span> <span class="kw">PSU_MOS</span>, 
                       PSUsamplestratum= <span class="fl">1</span>, 
                       min_sample= <span class="kw">minimum</span>, 
                       min_sample_index= <span class="fl">FALSE</span>, 
                       dataAll=<span class="kw">allocat</span>,
                       domAll= <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="kw">STRATUM</span>), 
                       f_sample= <span class="op">~</span> <span class="kw">ALLOC</span>, 
                       planned_min_sample= <span class="kw">NULL</span>, 
                       launch= <span class="kw">F</span>)
</pre></div>
<p>This is the overall sample design:</p>
<div class="sourceCode" id="cb28"><pre class="downlit">
<span class="kw">sample_2st</span>[[<span class="fl">2</span>]]
</pre></div>
<pre><code>##    Domain SRdom nSRdom SRdom+nSRdom SR_PSU_final_sample_unit NSR_PSU_final_sample_unit
## 1    1000     2      0            2                      287                         0
## 2    2000     3      4            7                      143                       232
## 3    3000     0      4            4                        0                       176
## 4    4000     0      1            1                        0                        33
## 5    5000     2      0            2                      172                         0
## 6    6000     1      1            2                       33                        49
## 7    7000     0      1            1                        0                        55
## 8    8000     0      1            1                        0                        56
## 9    9000     1      0            1                      581                         0
## 10  10000     6      0            6                      611                         0
## 11  11000     4     20           24                      155                      1053
## 12  12000     0      8            8                        0                       396
## 13  13000     1      0            1                      733                         0
## 14  14000     4      0            4                      601                         0
## 15  15000     9     17           26                      434                       883
## 16  16000     0     19           19                        0                       975
## 17  17000     1      0            1                       70                         0
## 18  18000     0      2            2                        0                        88
## 19  19000     0      4            4                        0                       175
## 20  20000     0      2            2                        0                        91
## 21  21000     1      0            1                       64                         0
## 22  22000     0      1            1                        0                        49
## 23  23000     0      2            2                        0                        89
## 24  24000     0      1            1                        0                        18
## 25  Total    35     88          123                     3884                      4418
## 26   Mean                                                162                       184</code></pre>
<div class="sourceCode" id="cb30"><pre class="downlit">
<span class="kw">des</span> <span class="op">&lt;-</span> <span class="kw">sample_2st</span>[[<span class="fl">2</span>]]
<span class="kw">des</span> <span class="op">&lt;-</span> <span class="kw">des</span>[<span class="fl">1</span><span class="op">:</span>(<span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="kw">des</span>)<span class="op">-</span><span class="fl">1</span>),]
<span class="kw">strat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="kw">des</span><span class="op">$</span><span class="kw">Domain</span>[<span class="fl">1</span><span class="op">:</span>(<span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="kw">des</span>)<span class="op">-</span><span class="fl">1</span>)])),<span class="st">"Tot"</span>)
<span class="fu"><a href="https://rdrr.io/r/graphics/barplot.html">barplot</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span>(<span class="kw">des</span>[<span class="fl">1</span><span class="op">:</span>(<span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="kw">des</span>)),<span class="fl">2</span><span class="op">:</span><span class="fl">3</span>]), names=<span class="kw">strat</span>,
        col=<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"darkblue"</span>,<span class="st">"red"</span>), las=<span class="fl">2</span>, xlab = <span class="st">"Stratum"</span>, cex.axis=<span class="fl">0.7</span>, cex.names=<span class="fl">0.7</span>)
<span class="fu"><a href="https://rdrr.io/r/graphics/legend.html">legend</a></span>(<span class="st">"topleft"</span>, 
       legend = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"Self Representative"</span>,<span class="st">"Non Self Representative"</span>),
       fill = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"darkblue"</span>, <span class="st">"red"</span>))
<span class="fu"><a href="https://rdrr.io/r/graphics/title.html">title</a></span>(<span class="st">"Distribution of allocated PSUs by domain"</span>)
</pre></div>
<p><img src="R2BEAT_workflow_from_frame_files/figure-html/unnamed-chunk-18-1.png" width="576"></p>
<div class="sourceCode" id="cb31"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/graphics/barplot.html">barplot</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span>(<span class="kw">des</span>[<span class="fl">1</span><span class="op">:</span>(<span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="kw">des</span>)),<span class="fl">5</span><span class="op">:</span><span class="fl">6</span>]), names=<span class="kw">strat</span>,
        col=<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"darkblue"</span>,<span class="st">"red"</span>), las=<span class="fl">2</span>, xlab = <span class="st">"Stratum"</span>, cex.axis=<span class="fl">0.7</span>, 
        cex.names=<span class="fl">0.7</span>)
<span class="fu"><a href="https://rdrr.io/r/graphics/legend.html">legend</a></span>(<span class="st">"topleft"</span>, 
       legend = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"Self Representative"</span>,<span class="st">"Non Self Representative"</span>),
       fill = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"darkblue"</span>, <span class="st">"red"</span>))
<span class="fu"><a href="https://rdrr.io/r/graphics/title.html">title</a></span>(<span class="st">"Distribution of allocated SSUs by domain"</span>)
</pre></div>
<p><img src="R2BEAT_workflow_from_frame_files/figure-html/unnamed-chunk-19-1.png" width="576"></p>
<p>and these are the selected PSUs:</p>
<div class="sourceCode" id="cb32"><pre class="downlit">
<span class="kw">selected_PSU</span> <span class="op">&lt;-</span> <span class="kw">sample_2st</span>[[<span class="fl">4</span>]]
<span class="kw">selected_PSU</span> <span class="op">&lt;-</span> <span class="kw">selected_PSU</span>[<span class="kw">selected_PSU</span><span class="op">$</span><span class="kw">PSU_final_sample_unit</span> <span class="op">&gt;</span> <span class="fl">0</span>,]
<span class="fu"><a href="https://rdrr.io/r/utils/write.table.html">write.table</a></span>(<span class="kw">sample_2st</span>[[<span class="fl">4</span>]],<span class="st">"Selected_PSUs.csv"</span>,sep=<span class="st">";"</span>,row.names=<span class="kw">F</span>,quote=<span class="kw">F</span>)
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="kw">selected_PSU</span>)
</pre></div>
<pre><code>##      Sampled_PSU       Pik Size_Stratum STRATUM PSU_ID PSU_MOS PSU_MOS.1 ALLOC threshold final_populationdom sampling_fraction SR SizeSR stratum N_PSU_Stratum PSU_final_sample_unit nSR
## 1              1 1.0000000       146162    1000    330  146162    146162   287  34321.78              197007       0.001456801  1 146162   10001             1                   213   0
## 2              1 1.0000000        50845    1000    309   50845     50845   287  34321.78              197007       0.001456801  1  50845   10002             1                    74   0
## 3              1 1.0000000        36195    2000    304   36195     36195   374  34954.01              261456       0.001430451  1  36195   20001             1                    52   0
## 4              1 1.0000000        34156    2000    342   34156     34156   374  34954.01              261456       0.001430451  1      0   20002             1                    49   0
## 5              1 1.0000000        29376    2000    315   29376     29376   374  34954.01              261456       0.001430451  1      0   20003             1                    42   0
## 1100           1 0.5583857        44403    2000    292   24794     24794   374  34954.01              261456       0.001430451  0      0   20004             2                    64   1</code></pre>
</div>
<div id="selection-of-ssus" class="section level1">
<h1 class="hasAnchor">
<a href="#selection-of-ssus" class="anchor"></a>Selection of SSUs</h1>
<p>Finally, we are able to select the Secondary Sample Units (the individuals) from the already selected PSUs (the municipalities). First, we load the population frame:</p>
<div class="sourceCode" id="cb34"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/load.html">load</a></span>(<span class="st">"Frame.RData"</span>)
</pre></div>
<p>and we proceed to select the sample in this way:</p>
<div class="sourceCode" id="cb35"><pre class="downlit">
<span class="kw">samp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/select_SSU.html">select_SSU</a></span>(df=<span class="kw">pop</span>,
                   PSU_code=<span class="st">"municipality"</span>,
                   SSU_code=<span class="st">"id_ind"</span>,
                   PSU_sampled=<span class="kw">selected_PSU</span>[<span class="kw">selected_PSU</span><span class="op">$</span><span class="kw">Sampled_PSU</span><span class="op">==</span><span class="fl">1</span>,],
                   verbose=<span class="fl">FALSE</span>)
</pre></div>
<p>To check that the total amount is practically equal to what determined in the allocation step:</p>
<div class="sourceCode" id="cb36"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="kw">samp</span>)
</pre></div>
<pre><code>## [1] 8302</code></pre>
<div class="sourceCode" id="cb38"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="kw">allocat</span><span class="op">$</span><span class="kw">ALLOC</span>)
</pre></div>
<pre><code>## [1] 8300</code></pre>
<p>and that the sum of weights equalize population size:</p>
<div class="sourceCode" id="cb40"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="kw">pop</span>)
</pre></div>
<pre><code>## [1] 2258507</code></pre>
<div class="sourceCode" id="cb42"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="kw">samp</span><span class="op">$</span><span class="kw">weight</span>)
</pre></div>
<pre><code>## [1] 2258507</code></pre>
<p>This is the distribution of weights:</p>
<div class="sourceCode" id="cb44"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span>(mfrow=<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">1</span>, <span class="fl">2</span>))
<span class="fu"><a href="https://rdrr.io/r/graphics/boxplot.html">boxplot</a></span>(<span class="kw">samp</span><span class="op">$</span><span class="kw">weight</span>,col=<span class="st">"orange"</span>)
<span class="fu"><a href="https://rdrr.io/r/graphics/title.html">title</a></span>(<span class="st">"Weights distribution (total sample)"</span>,cex.main=<span class="fl">0.7</span>)
<span class="fu"><a href="https://rdrr.io/r/graphics/boxplot.html">boxplot</a></span>(<span class="kw">weight</span> <span class="op">~</span> <span class="kw">region</span>, data=<span class="kw">samp</span>,col=<span class="st">"orange"</span>)
<span class="fu"><a href="https://rdrr.io/r/graphics/title.html">title</a></span>(<span class="st">"Weights distribution by region"</span>,cex.main=<span class="fl">0.7</span>)
</pre></div>
<p><img src="R2BEAT_workflow_from_frame_files/figure-html/unnamed-chunk-25-1.png" width="576"></p>
<div class="sourceCode" id="cb45"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/graphics/boxplot.html">boxplot</a></span>(<span class="kw">weight</span> <span class="op">~</span> <span class="kw">province</span>, data=<span class="kw">samp</span>,col=<span class="st">"orange"</span>)
<span class="fu"><a href="https://rdrr.io/r/graphics/title.html">title</a></span>(<span class="st">"Weights distribution by province"</span>,cex.main=<span class="fl">0.7</span>)
<span class="fu"><a href="https://rdrr.io/r/graphics/boxplot.html">boxplot</a></span>(<span class="kw">weight</span> <span class="op">~</span> <span class="kw">stratum</span>, data=<span class="kw">samp</span>,col=<span class="st">"orange"</span>)
<span class="fu"><a href="https://rdrr.io/r/graphics/title.html">title</a></span>(<span class="st">"Weights distribution by stratum"</span>,cex.main=<span class="fl">0.7</span>)
</pre></div>
<p><img src="R2BEAT_workflow_from_frame_files/figure-html/unnamed-chunk-25-2.png" width="576"></p>
<p>It can be seen that the sample is fully self-weighted inside strata, and approximately self-weighted in aggregations of strata, that is the result we wanted to obtain.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Andrea Fasulo, Raffaella Cianchetta, Giulio Barcaroli, Stefano Falorsi, Alessio Guandalini, Daniela Pagliuca, Marco Dionisio Terribili.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.9000.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
