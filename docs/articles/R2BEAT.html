<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Two-stage sampling design workflow • R2BEAT</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Two-stage sampling design workflow">
<meta property="og:description" content="R2BEAT">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">R2BEAT</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.0.2</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/R2BEAT.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/barcaroli/R2BEAT/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="R2BEAT_files/header-attrs-2.5/header-attrs.js"></script><link href="R2BEAT_files/anchor-sections-1.0/anchor-sections.css" rel="stylesheet">
<script src="R2BEAT_files/anchor-sections-1.0/anchor-sections.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Two-stage sampling design workflow</h1>
            
            <h4 class="date">2020-12-11 <br><br><br>
</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/barcaroli/R2BEAT/blob/master/vignettes/R2BEAT.Rmd"><code>vignettes/R2BEAT.Rmd</code></a></small>
      <div class="hidden name"><code>R2BEAT.Rmd</code></div>

    </div>

    
    
<p>This vignette describes a generalized procedure making use of methods implemented in two R packages developed in the Italian National Institute:</p>
<ol style="list-style-type: decimal">
<li>R2BEAT (“Multivariate optimal allocation for different domains in one and two stages stratified sample design”)</li>
<li>FS4 (“First Stage Stratification and Selection in Sampling”)</li>
</ol>
<p>The first package allows to determine the optimal allocation of both Primary Stage Units (PSUs) and Secondary Stage Units (SSU), while the second one performs a selection of the PSUs such that the final sample of SSU if of the self-weigthing type, i.e. the total inclusion probabilities (as resulting from the product between the inclusion probabilities of the PSUs and those of the SSUs) are near equal for all SSUs.</p>
<p>This general flow assumes that at least a previous round of the survey, whose sampling design has to be optimized, is available, and is characterized by the following steps:</p>
<div id="use-of-regenesees" class="section level1">
<h1 class="hasAnchor">
<a href="#use-of-regenesees" class="anchor"></a>Use of ReGenesees</h1>
<p>Perform externally the definition of the sample design, and possibly of the calibration step, using the R package ReGenesees (also developed in Istat), and make the design object and the calibrated object available. Moreover, check the presence of lonely strata:</p>
<div class="sourceCode" id="cb1"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/load.html">load</a></span>(<span class="st">"R2BEAT_ReGenesees.RData"</span>)   <span class="co"># ReGenesees design object</span>
</pre></div>
<p>This is the ‘design’ object:</p>
<div class="sourceCode" id="cb2"><pre class="downlit">
<span class="kw">des</span>
</pre></div>
<pre><code>## Stratified 2 - Stage Cluster Sampling Design (with replacement)
## - [49] strata (collapsed)
## - [789, 2236] clusters
## 
## Call:
## e.svydesign(sample_2st, ids = ~municipality + id_hh, strata = ~stratum_sub, 
##     weights = ~d, self.rep.str = ~SR, check.data = TRUE)</code></pre>
<p>and this is the calibrated object:</p>
<div class="sourceCode" id="cb4"><pre class="downlit">
<span class="kw">cal</span>
</pre></div>
<pre><code>## Calibrated, Stratified 2 - Stage Cluster Sampling Design (with replacement)
## - [49] strata (collapsed)
## - [789, 2236] clusters
## 
## Call:
## e.calibrate(design = des, df.population = pop, calmodel = ~clage:sex - 
##     1, partition = ~region, calfun = "logit", bounds = c(0.7, 
##     1.7), aggregate.stage = 2, force = FALSE)</code></pre>
<p>It is advisable to check the presence of lonely strata:</p>
<div class="sourceCode" id="cb6"><pre class="downlit">
<span class="co"># Control the presence of strata with less than two units</span>
<span class="kw">ls</span> <span class="op">&lt;-</span> <span class="fu">find.lon.strata</span>(<span class="kw">des</span>)
</pre></div>
<pre><code>## # No lonely PSUs found!</code></pre>
<p>In case, provide to collapse and re-do the calibration.</p>
<p>In this example, in the ReGenesees objects there are the following variables:</p>
<div class="sourceCode" id="cb8"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span>(<span class="kw">des</span><span class="op">$</span><span class="kw">variables</span>)
</pre></div>
<pre><code>## 'data.frame':    2244 obs. of  17 variables:
##  $ region               : Factor w/ 3 levels "north","center",..: 1 1 1 1 1 1 1 1 1 1 ...
##  $ municipality         : num  8 8 8 8 8 8 8 8 8 8 ...
##  $ stratum              : Factor w/ 24 levels "1000","2000",..: 9 9 9 9 9 9 9 9 9 9 ...
##  $ stratum_sub          : Factor w/ 81 levels "100001","100002",..: 81 81 81 81 81 81 81 81 81 81 ...
##  $ SR                   : Factor w/ 2 levels "0","1": 2 2 2 2 2 2 2 2 2 2 ...
##  $ id_hh                : Factor w/ 2236 levels "H100070","H100410",..: 69 43 64 49 367 27 372 373 374 368 ...
##  $ sex                  : Factor w/ 2 levels "1","2": 1 1 2 2 1 2 1 2 1 1 ...
##  $ clage                : Factor w/ 5 levels "cl0_17","cl18_34",..: 3 1 2 1 5 2 2 2 3 1 ...
##  $ income_hh            : num  43741 23284 23450 22171 19904 ...
##  $ work                 : num  1 1 1 2 0 1 1 1 1 2 ...
##  $ unemployed           : num  0 0 0 0 1 0 0 0 0 0 ...
##  $ d                    : num  1238 1238 1238 1238 1238 ...
##  $ progr_str            : num  1 1 1 1 1 1 1 1 1 1 ...
##  $ var.PSU              : chr  "8.H12425" "8.H10738" "8.H12157" "8.H11208" ...
##  $ stratum_sub.collapsed: Factor w/ 49 levels "0.center.clps.1",..: 49 49 49 49 49 49 49 49 49 49 ...
##  $ active               : Factor w/ 2 levels "0","1": 2 2 2 1 1 2 2 2 2 1 ...
##  $ inactive             : Factor w/ 2 levels "0","1": 1 1 1 2 1 1 1 1 1 2 ...</code></pre>
<p>where there are three potential target variables:</p>
<ol style="list-style-type: decimal">
<li>income_hh (numeric);</li>
<li>work (factor with values 0, 1, 2);</li>
<li>unemployed (factor with values 0, 1).</li>
</ol>
<div class="sourceCode" id="cb10"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span>(<span class="kw">des</span><span class="op">$</span><span class="kw">variables</span><span class="op">$</span><span class="kw">income_hh</span>)
</pre></div>
<pre><code>##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
##       0   11463   18516   21661   26763  532331</code></pre>
<div class="sourceCode" id="cb12"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span>(<span class="kw">des</span><span class="op">$</span><span class="kw">variables</span><span class="op">$</span><span class="kw">work</span>)
</pre></div>
<pre><code>## 
##    0    1    2 
##  306 1487  451</code></pre>
<div class="sourceCode" id="cb14"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span>(<span class="kw">des</span><span class="op">$</span><span class="kw">variables</span><span class="op">$</span><span class="kw">unemployed</span>)
</pre></div>
<pre><code>## 
##    0    1 
## 1938  306</code></pre>
<p>Great attention must be paid to the nature of the target variables, especially of the ‘factor’ type. In fact, the procedure here illustrated is suitable only when categorical variables are binary with values 0 and 1, supposing we are willing to estimate proportions of ‘1’ in the population. If factor variables are of other nature, then an error message is printed.</p>
<p>Therefore, we have to handle the ‘work’ variable in this way: as values 0, 1 and 2 indicate respectively non labour force, active and inactive people, we can decide to derive from ‘work’ two binary variables, ‘active’ and ‘inactive’:</p>
<div class="sourceCode" id="cb16"><pre class="downlit">
<span class="kw">des</span><span class="op">&lt;-</span><span class="fu">des.addvars</span>(<span class="kw">des</span>,active=<span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(<span class="kw">work</span><span class="op">==</span><span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">0</span>)))
<span class="kw">des</span><span class="op">&lt;-</span><span class="fu">des.addvars</span>(<span class="kw">des</span>,inactive=<span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(<span class="kw">work</span><span class="op">==</span><span class="fl">2</span>,<span class="fl">1</span>,<span class="fl">0</span>)))
<span class="kw">cal</span><span class="op">&lt;-</span><span class="fu">des.addvars</span>(<span class="kw">cal</span>,active=<span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(<span class="kw">work</span><span class="op">==</span><span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">0</span>)))
<span class="kw">cal</span><span class="op">&lt;-</span><span class="fu">des.addvars</span>(<span class="kw">cal</span>,inactive=<span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(<span class="kw">work</span><span class="op">==</span><span class="fl">2</span>,<span class="fl">1</span>,<span class="fl">0</span>)))
</pre></div>
<p>Now, all the categorical target variables are compliant to the binary constraint:</p>
<div class="sourceCode" id="cb17"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span>(<span class="kw">cal</span><span class="op">$</span><span class="kw">variables</span><span class="op">$</span><span class="kw">active</span>)
</pre></div>
<pre><code>## 
##    0    1 
##  757 1487</code></pre>
<div class="sourceCode" id="cb19"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span>(<span class="kw">cal</span><span class="op">$</span><span class="kw">variables</span><span class="op">$</span><span class="kw">inactive</span>)
</pre></div>
<pre><code>## 
##    0    1 
## 1793  451</code></pre>
<div class="sourceCode" id="cb21"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span>(<span class="kw">cal</span><span class="op">$</span><span class="kw">variables</span><span class="op">$</span><span class="kw">unemployed</span>)
</pre></div>
<pre><code>## 
##    0    1 
## 1938  306</code></pre>
</div>
<div id="build-strata-deff-effst-and-rho-dataframes" class="section level1">
<h1 class="hasAnchor">
<a href="#build-strata-deff-effst-and-rho-dataframes" class="anchor"></a>Build ‘strata’, ‘deff’, ‘effst’ and ‘rho’ dataframes</h1>
<p>Using ReGenesees objects as input, produce the following dataframes (function ‘input_to_beat.2st_1’):</p>
<ol style="list-style-type: lower-alpha">
<li>the ‘stratif’ dataframe containing:</li>
</ol>
<ul>
<li>STRATUM: identifier of the single stratum</li>
<li>N: total population in terms of final sampling units</li>
<li>Mi,Si: mean and standard deviation of target variables (i=1,2,..,P)</li>
<li>DOMk: domain(s) to which the stratum belongs</li>
</ul>
<ol start="2" style="list-style-type: lower-alpha">
<li>the ‘deff’ (design effect) dataframe, containing the following information:</li>
</ol>
<ul>
<li>STRATUM: the stratum identifier</li>
<li>DEFFi: the design effect for each target variable i (i=1,2,…,P)</li>
</ul>
<ol start="3" style="list-style-type: lower-alpha">
<li>the ‘effst’ (estimator effect) dataframe, containing the following information:</li>
</ol>
<ul>
<li>STRATUM: the stratum identifier</li>
<li>EFFSTi: the estimator effect for each target variable i (i=1,2,…,P)</li>
</ul>
<ol start="4" style="list-style-type: lower-alpha">
<li>the ‘rho’ (intraclass coefficient of correlation) dataframe, containing the following information:</li>
</ol>
<ul>
<li>STRATUM: the stratum identifier</li>
<li>RHO_ARi: the intraclass coefficient of correlation in self-representative PSUs for each target variable i (i=1,2,…,P)</li>
<li>RHO_NARi: the intraclass coefficient of correlation in non self-representative PSUs for each target variable i (i=1,2,…,P)</li>
</ul>
<p>Actually, the ‘deff’ dataframe is not used in the following steps, it just remains for documentation purposes.</p>
<p>Here is the way we can produce the above items:</p>
<div class="sourceCode" id="cb23"><pre class="downlit">
<span class="kw">RGdes</span> <span class="op">&lt;-</span> <span class="kw">des</span>                           <span class="co"># ReGenesees design object</span>
<span class="kw">RGcal</span> <span class="op">&lt;-</span> <span class="kw">cal</span>                           <span class="co"># ReGenesees calibrated object</span>

<span class="kw">strata_vars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"stratum"</span>)            <span class="co"># variables of stratification</span>
<span class="kw">target_vars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"income_hh"</span>,
                 <span class="st">"active"</span>,
                 <span class="st">"inactive"</span>,
                 <span class="st">"unemployed"</span>)         <span class="co"># target variables</span>
<span class="kw">deff_vars</span> <span class="op">&lt;-</span> <span class="st">"stratum"</span>                 <span class="co"># stratification variables to be used when calculating deff and effst </span>
                                       <span class="co">#    (n.b: must coincide or be a subset of variables of stratification)</span>
<span class="kw">id_PSU</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"municipality"</span>)            <span class="co"># identification variable of PSUs</span>
<span class="kw">id_SSU</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"id_hh"</span>)                   <span class="co"># identification variable of SSUs</span>
<span class="kw">domain_vars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"region"</span>)             <span class="co"># domain variables</span>
<span class="kw">inp1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/input_to_beat.2st_1.html">input_to_beat.2st_1</a></span>(<span class="kw">RGdes</span>,
                            <span class="kw">RGcal</span>,
                            <span class="kw">id_PSU</span>,
                            <span class="kw">id_SSU</span>,
                            <span class="kw">strata_vars</span>,
                            <span class="kw">target_vars</span>,
                            <span class="kw">deff_vars</span>,
                            <span class="kw">domain_vars</span>)
</pre></div>
<p>and these are the results:</p>
<div class="sourceCode" id="cb24"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="kw">inp1</span><span class="op">$</span><span class="kw">strata</span>)
</pre></div>
<pre><code>##   stratum STRATUM      N       M1        M2        M3         M4       S1        S2        S3        S4 COST CENS DOM1   DOM2
## 1    1000    1000 197451 22266.58 0.6404431 0.2323140 0.12724293 14554.88 0.4798705 0.4223082 0.3332449    1    0    1 center
## 2   10000   10000 106106 27985.40 0.7679285 0.2114187 0.02065276 24367.97 0.4221544 0.4083146 0.1422189    1    0    1  north
## 3   11000   11000 202700 29173.85 0.8029080 0.1730880 0.02400395 39232.92 0.3978024 0.3783234 0.1530613    1    0    1  north
## 4   12000   12000  57420 26937.42 0.7764955 0.2075926 0.01591188 15743.78 0.4165936 0.4055834 0.1251347    1    0    1  north
## 5   13000   13000 103089 26357.25 0.7185271 0.2814729 0.00000000 14592.50 0.4497176 0.4497176 0.0000000    1    0    1  north
## 6   14000   14000  84653 20538.42 0.7518236 0.2131042 0.03507211 14285.81 0.4319547 0.4095007 0.1839621    1    0    1  north</code></pre>
<div class="sourceCode" id="cb26"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="kw">inp1</span><span class="op">$</span><span class="kw">deff</span>)
</pre></div>
<pre><code>##   stratum STRATUM    DEFF1    DEFF2    DEFF3    DEFF4    b_nar
## 1    1000    1000 0.951705 0.991140 1.006731 0.954024 56.50000
## 2   10000   10000 0.856598 1.687606 1.404308 0.819854 26.75000
## 3   11000   11000 1.811807 1.261816 1.346654 1.339464 23.77778
## 4   12000   12000 1.086363 0.502458 0.483954 0.700691 21.00000
## 5   13000   13000 1.000924 1.000924 1.000924 1.000000 95.00000
## 6   14000   14000 0.633543 0.856820 0.845580 0.677276 33.66667</code></pre>
<div class="sourceCode" id="cb28"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="kw">inp1</span><span class="op">$</span><span class="kw">effst</span>)
</pre></div>
<pre><code>##   stratum STRATUM    EFFST1 EFFST2 EFFST3    EFFST4
## 1    1000    1000 0.9689494      1      1 0.9420958
## 2   10000   10000 0.9500011      1      1 1.1915475
## 3   11000   11000 0.9544521      1      1 1.0546196
## 4   12000   12000 1.0429461      1      1 0.9732493
## 5   13000   13000 0.9914219      1      1 1.0000000
## 6   14000   14000 0.9829167      1      1 1.0974521</code></pre>
<div class="sourceCode" id="cb30"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="kw">inp1</span><span class="op">$</span><span class="kw">rho</span>)
</pre></div>
<pre><code>##   STRATUM RHO_AR1        RHO_NAR1 RHO_AR2        RHO_NAR2 RHO_AR3        RHO_NAR3 RHO_AR4      RHO_NAR4
## 1    1000       1 -0.000870180180       1 -0.000159639640       1  0.000121279279       1 -0.0008283964
## 2   10000       1 -0.005569009709       1  0.026703145631       1  0.015701281553       1 -0.0069959612
## 3   11000       1  0.035640307317       1  0.011494360976       1  0.015218956098       1  0.0149032976
## 4   12000       1  0.004318150000       1 -0.024877100000       1 -0.025802300000       1 -0.0149654500
## 5   13000       1  0.000009829787       1  0.000009829787       1  0.000009829787       1  0.0000000000
## 6   14000       1 -0.011218071429       1 -0.004383061224       1 -0.004727142857       1 -0.0098793061</code></pre>
</div>
<div id="build-psu-and-design-dataframes" class="section level1">
<h1 class="hasAnchor">
<a href="#build-psu-and-design-dataframes" class="anchor"></a>Build ‘PSU’ and ‘design’ dataframes</h1>
<p>Prepare the inputs related to the PSUs (function ‘input_to_strat.2d_2’), that are</p>
<ol style="list-style-type: lower-alpha">
<li>the ‘des_file’ dataframe, containing the following information:</li>
</ol>
<ul>
<li>STRATUM: stratum identifier</li>
<li>MOS: measure of size of the stratum (in terms of number of contained selection units)</li>
<li>DELTA: factor that report the average number of SSUs for each selection unit</li>
<li>MINIMUM: minimum number of units to be selected in each PSU</li>
</ul>
<ol start="2" style="list-style-type: lower-alpha">
<li>the ‘PSU_file’ dataframe, containing the following information:</li>
</ol>
<ul>
<li>stratum identifier</li>
<li>PSU id</li>
<li>PSU_MOS: number of selection units contained in a given PSU</li>
</ul>
<div class="sourceCode" id="cb32"><pre class="downlit">
<span class="co"># psu &lt;- read.csv2("psu.csv") # Read the external file containing PSU information</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="kw">psu</span>)
</pre></div>
<pre><code>##   municipality stratum   ind   hh
## 1            1   12000  1546  609
## 2            2   12000   936  402
## 3            3   12000   367  178
## 4            4   10000 13032 5788
## 5            5   12000   678  281
## 6            6   11000  3193 1194</code></pre>
<div class="sourceCode" id="cb34"><pre class="downlit">
<span class="kw">psu_id</span><span class="op">=</span><span class="st">"municipality"</span>        <span class="co"># Identifier of the PSU</span>
<span class="kw">stratum_var</span><span class="op">=</span><span class="st">"stratum"</span>        <span class="co"># Identifier of the stratum</span>
<span class="kw">mos_var</span><span class="op">=</span><span class="st">"ind"</span>                <span class="co"># Variable to be used as 'measure of size'</span>
<span class="kw">delta</span><span class="op">=</span><span class="fl">1</span>                      <span class="co"># Average number of SSUs for each selection unit</span>
<span class="kw">minimum</span> <span class="op">&lt;-</span> <span class="fl">50</span>                <span class="co"># Minimum number of SSUs to be selected in each PSU</span>
<span class="kw">inp2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/input_to_beat.2st_2.html">input_to_beat.2st_2</a></span>(<span class="kw">psu</span>,
                            <span class="kw">psu_id</span>,
                            <span class="kw">stratum_var</span>,
                            <span class="kw">mos_var</span>,
                            <span class="kw">delta</span>,
                            <span class="kw">minimum</span>)
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="kw">inp2</span><span class="op">$</span><span class="kw">psu_file</span>)
</pre></div>
<pre><code>##   PSU_ID STRATUM PSU_MOS
## 1      1   12000    1546
## 2      2   12000     936
## 3      3   12000     367
## 4      4   10000   13032
## 5      5   12000     678
## 6      6   11000    3193</code></pre>
<div class="sourceCode" id="cb36"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="kw">inp2</span><span class="op">$</span><span class="kw">des_file</span>)
</pre></div>
<pre><code>##   STRATUM STRAT_MOS DELTA MINIMUM
## 1    1000    197007     1      50
## 2    2000    261456     1      50
## 3    3000    115813     1      50
## 4    4000     17241     1      50
## 5    5000    101067     1      50
## 6    6000     47218     1      50</code></pre>
</div>
<div id="optimal-allocation-of-units-in-each-stratum" class="section level1">
<h1 class="hasAnchor">
<a href="#optimal-allocation-of-units-in-each-stratum" class="anchor"></a>Optimal allocation of units in each stratum</h1>
<p>Using the function ‘beat.2st’ in ‘R2BEAT’ package execute the optimization of PSU and SSU allocation in strata:</p>
<div class="sourceCode" id="cb38"><pre class="downlit">
<span class="kw">cv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(DOM=<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"DOM1"</span>,<span class="st">"DOM2"</span>),
                         CV1=<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0.03</span>,<span class="fl">0.04</span>),
                         CV2=<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0.06</span>,<span class="fl">0.08</span>),
                         CV3=<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0.06</span>,<span class="fl">0.08</span>),
                         CV4=<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0.06</span>,<span class="fl">0.08</span>)))
<span class="kw">cv</span>
</pre></div>
<pre><code>##    DOM  CV1  CV2  CV3  CV4
## 1 DOM1 0.03 0.06 0.06 0.06
## 2 DOM2 0.04 0.08 0.08 0.08</code></pre>
<div class="sourceCode" id="cb40"><pre class="downlit">
<span class="kw">stratif</span> <span class="op">=</span> <span class="kw">inp1</span><span class="op">$</span><span class="kw">strata</span> 
<span class="kw">errors</span> <span class="op">=</span> <span class="kw">cv</span> 
<span class="kw">des_file</span> <span class="op">=</span> <span class="kw">inp2</span><span class="op">$</span><span class="kw">des_file</span> 
<span class="kw">psu_file</span> <span class="op">=</span> <span class="kw">inp2</span><span class="op">$</span><span class="kw">psu_file</span> 
<span class="kw">rho</span> <span class="op">=</span> <span class="kw">inp1</span><span class="op">$</span><span class="kw">rho</span> 
<span class="kw">effst</span> <span class="op">=</span> <span class="kw">inp1</span><span class="op">$</span><span class="kw">effst</span>

<span class="kw">alloc</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/beat.2st.html">beat.2st</a></span>(<span class="kw">stratif</span>, 
                  <span class="kw">errors</span>, 
                  <span class="kw">des_file</span>, 
                  <span class="kw">psu_file</span>, 
                  <span class="kw">rho</span>, 
                  deft_start = <span class="kw">NULL</span>, 
                  <span class="kw">effst</span>,
                  epsilon1 = <span class="fl">5</span>, 
                  mmdiff_deft = <span class="fl">1</span>,maxi = <span class="fl">15</span>, 
                  epsilon = <span class="fl">10</span><span class="op">^</span>(<span class="op">-</span><span class="fl">11</span>), minnumstrat = <span class="fl">2</span>, maxiter = <span class="fl">200</span>, maxiter1 = <span class="fl">25</span>)
</pre></div>
<pre><code>##   iterations PSU_SR PSU NSR PSU Total  SSU
## 1          0      0       0         0 6534
## 2          1     38      62       100 8990
## 3          2     22     124       146 9447
## 4          3     23     125       148 9424</code></pre>
<p>This is the sensitivity of the solution:</p>
<div class="sourceCode" id="cb42"><pre class="downlit">
<span class="kw">alloc</span><span class="op">$</span><span class="kw">sensitivity</span>
</pre></div>
<pre><code>##    Type Dom  V1 V2 V3   V4
## 1  DOM1   1   1  0  1    1
## 5  DOM2   1   1  0  3 1641
## 9  DOM2   2  25  1 14   68
## 13 DOM2   3 128  1  8    1</code></pre>
<p>i.e., for each domain value and for each variable it is reported the gain in terms of reduction in the sample size if the corresponding precision constraint is reduced of 10%.</p>
<p>This are the expected values of the coefficients of variation:</p>
<div class="sourceCode" id="cb44"><pre class="downlit">
<span class="kw">alloc</span><span class="op">$</span><span class="kw">expected</span>
</pre></div>
<pre><code>##    Type Dom     V1     V2     V3     V4
## 1  DOM1   1 0.0188 0.0159 0.0465 0.0444
## 5  DOM2   1 0.0230 0.0202 0.0770 0.0800
## 9  DOM2   2 0.0399 0.0306 0.0788 0.0798
## 13 DOM2   3 0.0400 0.0402 0.0792 0.0605</code></pre>
</div>
<div id="selection-of-psus" class="section level1">
<h1 class="hasAnchor">
<a href="#selection-of-psus" class="anchor"></a>Selection of PSUs</h1>
<p>Using the function ‘StratSel’ in ‘FS4’ package execute the selection of PSU in strata:</p>
<div class="sourceCode" id="cb46"><pre class="downlit">
<span class="kw">allocat</span> <span class="op">&lt;-</span> <span class="kw">alloc</span><span class="op">$</span><span class="kw">alloc</span>[<span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="kw">alloc</span><span class="op">$</span><span class="kw">alloc</span>),]
<span class="kw">sample_2st</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/StratSel.html">StratSel</a></span>(dataPop= <span class="kw">inp2</span><span class="op">$</span><span class="kw">psu_file</span>,
                       idpsu= <span class="op">~</span> <span class="kw">PSU_ID</span>, 
                       dom= <span class="op">~</span> <span class="kw">STRATUM</span>, 
                       final_pop= <span class="op">~</span> <span class="kw">PSU_MOS</span>, 
                       size= <span class="op">~</span> <span class="kw">PSU_MOS</span>, 
                       PSUsamplestratum= <span class="fl">1</span>, 
                       min_sample= <span class="kw">minimum</span>, 
                       min_sample_index= <span class="fl">FALSE</span>, 
                       dataAll=<span class="kw">allocat</span>,
                       domAll= <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="kw">STRATUM</span>), 
                       f_sample= <span class="op">~</span> <span class="kw">ALLOC</span>, 
                       planned_min_sample= <span class="kw">NULL</span>, 
                       launch= <span class="kw">F</span>)
</pre></div>
<p>This is the overall sample design:</p>
<div class="sourceCode" id="cb47"><pre class="downlit">
<span class="kw">sample_2st</span>[[<span class="fl">2</span>]]
</pre></div>
<pre><code>##    Domain SRdom nSRdom SRdom+nSRdom SR_PSU_final_sample_unit NSR_PSU_final_sample_unit
## 1    1000     2      0            2                      161                         0
## 2    2000     0      3            3                        0                       169
## 3    3000     0      1            1                        0                        47
## 4    4000     0      1            1                        0                         4
## 5    5000     2      0            2                       95                         0
## 6    6000     0      1            1                        0                        42
## 7    7000     0      1            1                        0                         8
## 8    8000     0      1            1                        0                         7
## 9    9000     1      0            1                      967                         0
## 10  10000     6      0            6                      765                         0
## 11  11000    15     20           35                      690                      1074
## 12  12000     0      3            3                        0                       154
## 13  13000     1      0            1                       11                         0
## 14  14000     4      0            4                      726                         0
## 15  15000     8     16           24                      367                       845
## 16  16000    14     38           52                      585                      2033
## 17  17000     1      0            1                       50                         0
## 18  18000     0      2            2                        0                        80
## 19  19000     0      6            6                        0                       319
## 20  20000     0      1            1                        0                        47
## 21  21000     1      0            1                       52                         0
## 22  22000     0      1            1                        0                        46
## 23  23000     0      2            2                        0                        77
## 24  24000     0      1            1                        0                         5
## 25  Total    55     98          153                     4469                      4957
## 26   Mean                                                186                       207</code></pre>
<div class="sourceCode" id="cb49"><pre class="downlit">
<span class="kw">des</span> <span class="op">&lt;-</span> <span class="kw">sample_2st</span>[[<span class="fl">2</span>]]
<span class="kw">des</span> <span class="op">&lt;-</span> <span class="kw">des</span>[<span class="fl">1</span><span class="op">:</span>(<span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="kw">des</span>)<span class="op">-</span><span class="fl">1</span>),]
<span class="kw">strat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="kw">des</span><span class="op">$</span><span class="kw">Domain</span>[<span class="fl">1</span><span class="op">:</span>(<span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="kw">des</span>)<span class="op">-</span><span class="fl">1</span>)])),<span class="st">"Tot"</span>)
<span class="fu"><a href="https://rdrr.io/r/graphics/barplot.html">barplot</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span>(<span class="kw">des</span>[<span class="fl">1</span><span class="op">:</span>(<span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="kw">des</span>)),<span class="fl">2</span><span class="op">:</span><span class="fl">3</span>]), names=<span class="kw">strat</span>,
        col=<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"darkblue"</span>,<span class="st">"red"</span>), las=<span class="fl">2</span>, xlab = <span class="st">"Stratum"</span>, cex.axis=<span class="fl">0.7</span>, cex.names=<span class="fl">0.7</span>)
<span class="fu"><a href="https://rdrr.io/r/graphics/legend.html">legend</a></span>(<span class="st">"topleft"</span>, 
       legend = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"Self Representative"</span>,<span class="st">"Non Self Representative"</span>),
       fill = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"darkblue"</span>, <span class="st">"red"</span>))
<span class="fu"><a href="https://rdrr.io/r/graphics/title.html">title</a></span>(<span class="st">"Distribution of allocated PSUs by domain"</span>)
</pre></div>
<p><img src="R2BEAT_files/figure-html/unnamed-chunk-25-1.png" width="576"></p>
<div class="sourceCode" id="cb50"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/graphics/barplot.html">barplot</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span>(<span class="kw">des</span>[<span class="fl">1</span><span class="op">:</span>(<span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="kw">des</span>)),<span class="fl">5</span><span class="op">:</span><span class="fl">6</span>]), names=<span class="kw">strat</span>,
        col=<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"darkblue"</span>,<span class="st">"red"</span>), las=<span class="fl">2</span>, xlab = <span class="st">"Stratum"</span>, cex.axis=<span class="fl">0.7</span>, 
        cex.names=<span class="fl">0.7</span>)
<span class="fu"><a href="https://rdrr.io/r/graphics/legend.html">legend</a></span>(<span class="st">"topleft"</span>, 
       legend = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"Self Representative"</span>,<span class="st">"Non Self Representative"</span>),
       fill = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"darkblue"</span>, <span class="st">"red"</span>))
<span class="fu"><a href="https://rdrr.io/r/graphics/title.html">title</a></span>(<span class="st">"Distribution of allocated SSUs by domain"</span>)
</pre></div>
<p><img src="R2BEAT_files/figure-html/unnamed-chunk-26-1.png" width="576"></p>
<p>and these are the selected PSUs:</p>
<div class="sourceCode" id="cb51"><pre class="downlit">
<span class="kw">selected_PSU</span> <span class="op">&lt;-</span> <span class="kw">sample_2st</span>[[<span class="fl">4</span>]]
<span class="kw">selected_PSU</span> <span class="op">&lt;-</span> <span class="kw">selected_PSU</span>[<span class="kw">selected_PSU</span><span class="op">$</span><span class="kw">PSU_final_sample_unit</span> <span class="op">&gt;</span> <span class="fl">0</span>,]
<span class="fu"><a href="https://rdrr.io/r/utils/write.table.html">write.table</a></span>(<span class="kw">sample_2st</span>[[<span class="fl">4</span>]],<span class="st">"Selected_PSUs.csv"</span>,sep=<span class="st">";"</span>,row.names=<span class="kw">F</span>,quote=<span class="kw">F</span>)
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="kw">selected_PSU</span>)
</pre></div>
<pre><code>##      Sampled_PSU        Pik Size_Stratum STRATUM PSU_ID PSU_MOS PSU_MOS.1 ALLOC threshold final_populationdom sampling_fraction SR SizeSR stratum N_PSU_Stratum PSU_final_sample_unit nSR
## 1              1 1.00000000       146162    1000    330  146162    146162   161  61182.30              197007      0.0008172298  1 146162   10001             1                   119   0
## 2              1 1.00000000        50845    1000    309   50845     50845   161  61182.30              197007      0.0008172298  1      0   10002             1                    42   0
## 1100           1 0.36294083        99727    2000    304   36195     36195   169  77353.85              261456      0.0006463803  0      0   20001             3                    64   1
## 7              1 0.21265470        80318    2000    318   17080     17080   169  77353.85              261456      0.0006463803  0      0   20002             4                    52   1
## 12             1 0.16483031        81411    2000    317   13419     13419   169  77353.85              261456      0.0006463803  0      0   20003             6                    53   1
## 24             1 0.03968466       115813    3000    295    4596      4596    47 123205.32              115813      0.0004058266  0      0   30001            26                    47   1</code></pre>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Andrea Fasulo, Stefano Falorsi, Alessio Guandalini, Daniela Pagliuca, Marco Dionisio Terribili, Raffaella Cianchetta, Giulio Barcaroli.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
