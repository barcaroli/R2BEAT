<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>R2BEAT
 Optimization of precision constraints • R2BEAT</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="R2BEAT
 Optimization of precision constraints">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">


    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">R2BEAT</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">1.0.6</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles

    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/CVs_optimization.html">R2BEAT
 Optimization of precision constraints</a>
    </li>
    <li>
      <a href="../articles/R2BEAT_methodology.html">R2BEAT methodology and use</a>
    </li>
    <li>
      <a href="../articles/R2BEAT_workflow_from_frame.html">R2BEAT two-stage sampling design workflow starting from the sampling frame</a>
    </li>
    <li>
      <a href="../articles/R2BEAT_workflow.html">R2BEAT two-stage sampling design workflow starting from a previous survey</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/barcaroli/R2BEAT/" class="external-link">
    <span class="fab fa-github fa-lg"></span>

  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->



      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>R2BEAT Optimization of precision
constraints</h1>
            
            <h4 data-toc-skip class="date">2025-01-08 <br><br><br>
</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/barcaroli/R2BEAT/blob/master/vignettes/CVs_optimization.Rmd" class="external-link"><code>vignettes/CVs_optimization.Rmd</code></a></small>
      <div class="hidden name"><code>CVs_optimization.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<ol style="list-style-type: decimal">
<li><p>In a multivariate stratified sampling design procedure, very
often the values of the precision constraints (expressed in terms of
maximum expected coefficients of variation set on the target estimates)
are set without considering the peculiarities of the distributions of
the target variables. As a result, few variables (or even only one) may
be responsible for the optimization of the allocation, leaving the
others completely ineffective. This is because some precision
constraints are very tight and the other ones too loose. This is the
reason why the R2BEAT package has been provided with an additional
function (‘CVs_hint’) aiming at modifying the initial set of precision
constraints to let each target variable influence the optimization
process. This is done by considering the variability of the target
variables in the different strata: initial precision constraints are
adjusted so to relax those pertaining to the variables characterized by
a higher variability, and to tighten those related to the variables with
less variability.</p></li>
<li><p>Another issue is related to the characteristics of the allocation
of sampling units in the strata: it may happen that it can be very
different from the proportional one. In some cases it may be desirable
to limit the distance between the two allocations, avoiding the cases of
too much oversampling in small strata. It is possible to obtain this,
also in this case by changing the precision constraints. To get this
result, it is possible to make use of a genetic algorithm, that explores
the space of the possible combinations of values of the precision
constraints, with the aim of maximizing the coefficient of correlation
of the two distributions (optimal and proportional
allocations).</p></li>
</ol>
</div>
<div class="section level2">
<h2 id="setting">1. Setting<a class="anchor" aria-label="anchor" href="#setting"></a>
</h2>
<p>In this study, we show how it is possible to start from a “neutral”
set of precision constraints (equal CVs for all variables for a given
domain level), and modify them, so to:</p>
<ul>
<li><p>first, balance the influence of all the variables on the
determination of the best allocation, or at least, to avoid that only a
small fraction plays a role;</p></li>
<li><p>secondly, get the optimal allocation closer to the proportional
one.</p></li>
</ul>
<p>We consider a strata dataframe containing information on labor force
in a country. Each stratum belongs to three different domain levels:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/load.html" class="external-link">load</a></span><span class="op">(</span><span class="st">"strata.RData"</span><span class="op">)</span></span>
<span><span class="co"># strata$DOM3 &lt;- NULL  # de-comment if you want to execute on 2 domains</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">strata</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## 'data.frame':    24 obs. of  18 variables:</span></span>
<span><span class="co">##  $ STRATUM      : chr  "north_1_3" "north_1_4" "north_1_5" "north_1_6" ...</span></span>
<span><span class="co">##  $ stratum_label: chr  "north_1_3" "north_1_4" "north_1_5" "north_1_6" ...</span></span>
<span><span class="co">##  $ DOM1         : chr  "National" "National" "National" "National" ...</span></span>
<span><span class="co">##  $ DOM2         : Factor w/ 3 levels "north","center",..: 1 1 1 1 1 1 1 1 2 2 ...</span></span>
<span><span class="co">##  $ N            : num  92780 105327 200757 53612 102907 ...</span></span>
<span><span class="co">##  $ M1           : num  0.748 0.776 0.782 0.776 0.757 ...</span></span>
<span><span class="co">##  $ M2           : num  0.227 0.203 0.199 0.203 0.21 ...</span></span>
<span><span class="co">##  $ M3           : num  0.0252 0.0214 0.0192 0.0211 0.0329 ...</span></span>
<span><span class="co">##  $ M4           : num  29464 29364 27095 25726 27749 ...</span></span>
<span><span class="co">##  $ S1           : num  0.434 0.417 0.413 0.417 0.429 ...</span></span>
<span><span class="co">##  $ S2           : num  0.419 0.402 0.399 0.402 0.407 ...</span></span>
<span><span class="co">##  $ S3           : num  0.157 0.145 0.137 0.144 0.178 ...</span></span>
<span><span class="co">##  $ S4           : num  29839 27542 23575 19557 24520 ...</span></span>
<span><span class="co">##  $ CENS         : num  0 0 0 0 0 0 0 0 0 0 ...</span></span>
<span><span class="co">##  $ COST         : num  1 1 1 1 1 1 1 1 1 1 ...</span></span>
<span><span class="co">##  $ alloc        : num  360 377 682 191 455 373 759 440 181 233 ...</span></span>
<span><span class="co">##  $ SOLUZ        : num  352 368 667 187 444 365 742 431 177 227 ...</span></span>
<span><span class="co">##  $ DOM3         : chr  "north_1_3" "north_1_4" "north_1_5" "north_1_6" ...</span></span></code></pre>
<p>We consider as target variables:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">target_vars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"active"</span>,<span class="st">"inactive"</span>,<span class="st">"unemployed"</span>,<span class="st">"income_hh"</span><span class="op">)</span></span>
<span><span class="va">target_vars</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "active"     "inactive"   "unemployed" "income_hh"</span></span></code></pre>
<p>We initially set the following precision constraints:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># De-comment if you want to execute on 2 domains</span></span>
<span><span class="co"># cv_equal &lt;- as.data.frame(list(DOM = c("DOM1","DOM2"),</span></span>
<span><span class="co">#                          CV1 = c(0.05,0.10),</span></span>
<span><span class="co">#                          CV2 = c(0.05,0.10),</span></span>
<span><span class="co">#                          CV3 = c(0.05,0.10),</span></span>
<span><span class="co">#                          CV4 = c(0.05,0.10)))</span></span>
<span><span class="co"># De-comment if you want to execute on 3 domains</span></span>
<span><span class="va">cv_equal</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>DOM <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"DOM1"</span>,<span class="st">"DOM2"</span>,<span class="st">"DOM3"</span><span class="op">)</span>,</span>
<span>                         CV1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.05</span>,<span class="fl">0.10</span>,<span class="fl">0.15</span><span class="op">)</span>,</span>
<span>                         CV2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.05</span>,<span class="fl">0.10</span>,<span class="fl">0.15</span><span class="op">)</span>,</span>
<span>                         CV3 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.05</span>,<span class="fl">0.10</span>,<span class="fl">0.15</span><span class="op">)</span>,</span>
<span>                         CV4 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.05</span>,<span class="fl">0.10</span>,<span class="fl">0.15</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">cv_equal</span></span></code></pre></div>
<pre><code><span><span class="co">##    DOM  CV1  CV2  CV3  CV4</span></span>
<span><span class="co">## 1 DOM1 0.05 0.05 0.05 0.05</span></span>
<span><span class="co">## 2 DOM2 0.10 0.10 0.10 0.10</span></span>
<span><span class="co">## 3 DOM3 0.15 0.15 0.15 0.15</span></span></code></pre>
<p>and proceed with an initial allocation:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">equal</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/beth1.html">beat.1st</a></span><span class="op">(</span><span class="va">strata</span>,<span class="va">cv_equal</span><span class="op">)</span></span></code></pre></div>
<p>with the following total sample size and sensitivity:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">equal</span><span class="op">$</span><span class="va">alloc</span><span class="op">$</span><span class="va">ALLOC</span><span class="op">[</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">equal</span><span class="op">$</span><span class="va">alloc</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 16973</span></span></code></pre>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">equal</span><span class="op">$</span><span class="va">sensitivity</span><span class="op">[</span><span class="va">equal</span><span class="op">$</span><span class="va">sensitivity</span><span class="op">$</span><span class="va">`Sensitivity 10%`</span> <span class="op">&gt;</span> <span class="fl">1</span>,<span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">##     Type Dom Var Planned CV Actual CV Sensitivity 10%</span></span>
<span><span class="co">## 20  DOM3   1  V3       0.15    0.1499              75</span></span>
<span><span class="co">## 24  DOM3   2  V3       0.15    0.1500              81</span></span>
<span><span class="co">## 28  DOM3   3  V3       0.15    0.1500              77</span></span>
<span><span class="co">## 32  DOM3   4  V3       0.15    0.1500              63</span></span>
<span><span class="co">## 36  DOM3   5  V3       0.15    0.1500              50</span></span>
<span><span class="co">## 40  DOM3   6  V3       0.15    0.1498              50</span></span>
<span><span class="co">## 44  DOM3   7  V3       0.15    0.1499              52</span></span>
<span><span class="co">## 48  DOM3   8  V3       0.15    0.1498              41</span></span>
<span><span class="co">## 52  DOM3   9  V3       0.15    0.1500             338</span></span>
<span><span class="co">## 56  DOM3  10  V3       0.15    0.1500             400</span></span>
<span><span class="co">## 60  DOM3  11  V3       0.15    0.1500             449</span></span>
<span><span class="co">## 64  DOM3  12  V3       0.15    0.1500             398</span></span>
<span><span class="co">## 68  DOM3  13  V3       0.15    0.1500             259</span></span>
<span><span class="co">## 72  DOM3  14  V3       0.15    0.1499             255</span></span>
<span><span class="co">## 76  DOM3  15  V3       0.15    0.1500             296</span></span>
<span><span class="co">## 80  DOM3  16  V3       0.15    0.1500             259</span></span>
<span><span class="co">## 83  DOM3  17  V2       0.15    0.1498              36</span></span>
<span><span class="co">## 87  DOM3  18  V2       0.15    0.1496              34</span></span>
<span><span class="co">## 91  DOM3  19  V2       0.15    0.1497              33</span></span>
<span><span class="co">## 95  DOM3  20  V2       0.15    0.1498              28</span></span>
<span><span class="co">## 99  DOM3  21  V2       0.15    0.1496              35</span></span>
<span><span class="co">## 103 DOM3  22  V2       0.15    0.1497              37</span></span>
<span><span class="co">## 107 DOM3  23  V2       0.15    0.1498              33</span></span>
<span><span class="co">## 111 DOM3  24  V2       0.15    0.1494              25</span></span></code></pre>
<p>We see that the 3rd variable ‘unemployed’ is the one that determines
almost always the optimal allocation, while the 2nd one (‘inactive’) has
a lower influence.</p>
</div>
<div class="section level2">
<h2 id="modification-of-initial-precision-constraints">2. Modification of initial precision constraints<a class="anchor" aria-label="anchor" href="#modification-of-initial-precision-constraints"></a>
</h2>
<p>We now try to change the initial precision constraints to balance the
effect of the target variables.</p>
<p>To this aim, we make use of the function ‘CVs_hint’. This function
modifies the initial values of CVs by considering the variability of the
target variables in the different strata, for each domain level:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cv_mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/CVs_hint.html">CVs_hint</a></span><span class="op">(</span><span class="va">strata</span>,<span class="va">cv_equal</span><span class="op">)</span></span>
<span><span class="va">cv_mod</span></span></code></pre></div>
<pre><code><span><span class="co">##    DOM        CV1       CV2       CV3        CV4</span></span>
<span><span class="co">## 1 DOM1 0.03604821 0.0947973 0.1326679 0.04540080</span></span>
<span><span class="co">## 2 DOM2 0.07808286 0.1897451 0.3435119 0.08979977</span></span>
<span><span class="co">## 3 DOM3 0.12188868 0.2824164 0.5094129 0.12909995</span></span></code></pre>
<p>Actually, these new CVs are in some cases much higher than the
initial ones. But we can see that the new corresponding sample size is
much lower than the initial one:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">intermediate1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/beth1.html">beat.1st</a></span><span class="op">(</span><span class="va">strata</span>,<span class="va">cv_mod</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">intermediate1</span><span class="op">$</span><span class="va">alloc</span><span class="op">$</span><span class="va">ALLOC</span><span class="op">[</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">intermediate1</span><span class="op">$</span><span class="va">alloc</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 2308</span></span></code></pre>
<p>To correctly compare the new values of the CVs to the initial ones,
we have to re-calculate them in correspondence to the same required
sample size. To do this, we make use of the function ‘adjustCVs’:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">target_size</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">equal</span><span class="op">$</span><span class="va">alloc</span><span class="op">$</span><span class="va">ALLOC</span><span class="op">[</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">equal</span><span class="op">$</span><span class="va">alloc</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">cv_mod2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/adjust_CVs.html">adjust_CVs</a></span><span class="op">(</span>target_size<span class="op">=</span> <span class="va">target_size</span>,</span>
<span>                   strata<span class="op">=</span><span class="va">strata</span>,</span>
<span>                   errors<span class="op">=</span><span class="va">cv_mod</span>,</span>
<span>                   adj_rate <span class="op">=</span> <span class="fl">0.05</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">##  Size:  2552</span></span>
<span><span class="co">##  Size:  2830</span></span>
<span><span class="co">##  Size:  3129</span></span>
<span><span class="co">##  Size:  3466</span></span>
<span><span class="co">##  Size:  3839</span></span>
<span><span class="co">##  Size:  4249</span></span>
<span><span class="co">##  Size:  4707</span></span>
<span><span class="co">##  Size:  5212</span></span>
<span><span class="co">##  Size:  5769</span></span>
<span><span class="co">##  Size:  6386</span></span>
<span><span class="co">##  Size:  7071</span></span>
<span><span class="co">##  Size:  7828</span></span>
<span><span class="co">##  Size:  8665</span></span>
<span><span class="co">##  Size:  9592</span></span>
<span><span class="co">##  Size:  10617</span></span>
<span><span class="co">##  Size:  11744</span></span>
<span><span class="co">##  Size:  13001</span></span>
<span><span class="co">##  Size:  14381</span></span>
<span><span class="co">##  Size:  15907</span></span>
<span><span class="co">##  Size:  17597</span></span>
<span><span class="co">##  Size:  17597</span></span></code></pre>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cv_mod2</span></span></code></pre></div>
<pre><code><span><span class="co">##    DOM        CV1        CV2        CV3        CV4</span></span>
<span><span class="co">## 1 DOM1 0.01292278 0.03398350 0.04755956 0.01627555</span></span>
<span><span class="co">## 2 DOM2 0.02799160 0.06802096 0.12314418 0.03219195</span></span>
<span><span class="co">## 3 DOM3 0.04369537 0.10124231 0.18261737 0.04628051</span></span></code></pre>
<p>We see now that only in only in a few cases the CVs are slightly
higher than in the initial set.</p>
<p>The new sensitivity:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">intermediate2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/beth1.html">beat.1st</a></span><span class="op">(</span><span class="va">strata</span>,<span class="va">cv_mod2</span><span class="op">)</span></span>
<span><span class="va">intermediate2</span><span class="op">$</span><span class="va">sensitivity</span><span class="op">[</span><span class="va">intermediate2</span><span class="op">$</span><span class="va">sensitivity</span><span class="op">$</span><span class="va">`Sensitivity 10%`</span> <span class="op">&gt;</span><span class="fl">1</span>,<span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">##     Type Dom Var Planned CV Actual CV Sensitivity 10%</span></span>
<span><span class="co">## 21  DOM3   1  V4 0.04628051    0.0462              80</span></span>
<span><span class="co">## 25  DOM3   2  V4 0.04628051    0.0462              82</span></span>
<span><span class="co">## 27  DOM3   3  V2 0.10124231    0.1012              65</span></span>
<span><span class="co">## 30  DOM3   4  V1 0.04369537    0.0437              61</span></span>
<span><span class="co">## 34  DOM3   5  V1 0.04369537    0.0436              66</span></span>
<span><span class="co">## 38  DOM3   6  V1 0.04369537    0.0437              66</span></span>
<span><span class="co">## 42  DOM3   7  V1 0.04369537    0.0436              16</span></span>
<span><span class="co">## 43  DOM3   7  V2 0.10124231    0.1012              48</span></span>
<span><span class="co">## 46  DOM3   8  V1 0.04369537    0.0436              76</span></span>
<span><span class="co">## 52  DOM3   9  V3 0.18261737    0.1825             230</span></span>
<span><span class="co">## 56  DOM3  10  V3 0.18261737    0.1826             272</span></span>
<span><span class="co">## 60  DOM3  11  V3 0.18261737    0.1826             304</span></span>
<span><span class="co">## 64  DOM3  12  V3 0.18261737    0.1826             272</span></span>
<span><span class="co">## 68  DOM3  13  V3 0.18261737    0.1825             175</span></span>
<span><span class="co">## 72  DOM3  14  V3 0.18261737    0.1826             173</span></span>
<span><span class="co">## 76  DOM3  15  V3 0.18261737    0.1826             201</span></span>
<span><span class="co">## 80  DOM3  16  V3 0.18261737    0.1826             176</span></span>
<span><span class="co">## 85  DOM3  17  V4 0.04628051    0.0462              79</span></span>
<span><span class="co">## 86  DOM3  18  V1 0.04369537    0.0437              91</span></span>
<span><span class="co">## 90  DOM3  19  V1 0.04369537    0.0437             120</span></span>
<span><span class="co">## 94  DOM3  20  V1 0.04369537    0.0437             143</span></span>
<span><span class="co">## 98  DOM3  21  V1 0.04369537    0.0437              89</span></span>
<span><span class="co">## 105 DOM3  22  V4 0.04628051    0.0463             272</span></span>
<span><span class="co">## 106 DOM3  23  V1 0.04369537    0.0437             165</span></span>
<span><span class="co">## 110 DOM3  24  V1 0.04369537    0.0437             206</span></span></code></pre>
<p>We see that now all the variables play a role in the determination of
the best allocation.</p>
</div>
<div class="section level2">
<h2 id="get-the-optimal-allocation-closer-to-the-proportional-one">3. Get the optimal allocation closer to the proportional one<a class="anchor" aria-label="anchor" href="#get-the-optimal-allocation-closer-to-the-proportional-one"></a>
</h2>
<p>Consider the last obtained solution:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">intermediate2</span><span class="op">$</span><span class="va">alloc</span></span></code></pre></div>
<pre><code><span><span class="co">##               STRATUM ALLOC        PROP      EQUAL</span></span>
<span><span class="co">## north_1_3   north_1_3  1146   736.19049   733.2083</span></span>
<span><span class="co">## north_1_4   north_1_4  1357   835.74840   733.2083</span></span>
<span><span class="co">## north_1_5   north_1_5  1520  1592.96610   733.2083</span></span>
<span><span class="co">## north_1_6   north_1_6  1359   425.40035   733.2083</span></span>
<span><span class="co">## north_2_3   north_2_3   875   816.54619   733.2083</span></span>
<span><span class="co">## north_2_4   north_2_4   862   665.73743   733.2083</span></span>
<span><span class="co">## north_2_5   north_2_5  1001  1450.38573   733.2083</span></span>
<span><span class="co">## north_2_6   north_2_6   876   791.74201   733.2083</span></span>
<span><span class="co">## center_1_3 center_1_3   400  1561.49670   733.2083</span></span>
<span><span class="co">## center_1_4 center_1_4   410  2066.31644   733.2083</span></span>
<span><span class="co">## center_1_5 center_1_5   323   899.59178   733.2083</span></span>
<span><span class="co">## center_1_6 center_1_6   304   124.21132   733.2083</span></span>
<span><span class="co">## center_2_3 center_2_3   330   801.70018   733.2083</span></span>
<span><span class="co">## center_2_4 center_2_4   328   373.22113   733.2083</span></span>
<span><span class="co">## center_2_5 center_2_5   317   235.43337   733.2083</span></span>
<span><span class="co">## center_2_6 center_2_6   377   198.25091   733.2083</span></span>
<span><span class="co">## south_1_3   south_1_3   395   484.95101   733.2083</span></span>
<span><span class="co">## south_1_4   south_1_4   452   585.63565   733.2083</span></span>
<span><span class="co">## south_1_5   south_1_5   599  1090.20941   733.2083</span></span>
<span><span class="co">## south_1_6   south_1_6   711   452.78334   733.2083</span></span>
<span><span class="co">## south_2_3   south_2_3   444   435.82668   733.2083</span></span>
<span><span class="co">## south_2_4   south_2_4  1357   328.19909   733.2083</span></span>
<span><span class="co">## south_2_5   south_2_5   825   561.87093   733.2083</span></span>
<span><span class="co">## south_2_6   south_2_6  1029    82.58537   733.2083</span></span>
<span><span class="co">##                 Total 17597 17597.00000 17597.0000</span></span></code></pre>
<p>We can calculate the Pearson correlation coefficient between the
optimal and proportional allocations:</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">cor</a></span><span class="op">(</span><span class="va">intermediate2</span><span class="op">$</span><span class="va">alloc</span><span class="op">$</span><span class="va">ALLOC</span><span class="op">[</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">intermediate2</span><span class="op">$</span><span class="va">alloc</span><span class="op">)</span><span class="op">]</span>,<span class="va">intermediate2</span><span class="op">$</span><span class="va">alloc</span><span class="op">$</span><span class="va">PROP</span><span class="op">[</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">intermediate2</span><span class="op">$</span><span class="va">alloc</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 0.09962086</span></span></code></pre>
<p>We want to get the optimal allocation closer to the proportional one.
For instance, we want that the correlation coefficient be increased to
0.5.</p>
<p>To obtain this result, we make use of a particular genetic algorithm,
the quantum genetic algorithm, implemented in the R package QGA.</p>
<div class="section level3">
<h3 id="fitness-function">3.1 Fitness function<a class="anchor" aria-label="anchor" href="#fitness-function"></a>
</h3>
<p>First, we define the following fitness function:</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fitness_cvs</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">solution</span>,<span class="va">eval_func_inputs</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">strata</span> <span class="op">&lt;-</span> <span class="va">eval_func_inputs</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="va">vett</span> <span class="op">&lt;-</span> <span class="va">eval_func_inputs</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="va">cv</span> <span class="op">&lt;-</span> <span class="va">eval_func_inputs</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="va">vettmin</span> <span class="op">&lt;-</span> <span class="va">eval_func_inputs</span><span class="op">[[</span><span class="fl">4</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="va">vettmax</span> <span class="op">&lt;-</span> <span class="va">eval_func_inputs</span><span class="op">[[</span><span class="fl">5</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="va">nvals</span> <span class="op">&lt;-</span> <span class="va">eval_func_inputs</span><span class="op">[[</span><span class="fl">6</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="va">nvars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">cv</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span></span>
<span>  <span class="va">cv_corr</span> <span class="op">&lt;-</span> <span class="va">cv</span></span>
<span>  <span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">k</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">cv</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw">for</span> <span class="op">(</span><span class="va">m</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">nvars</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">n</span> <span class="op">&lt;-</span> <span class="va">n</span><span class="op">+</span><span class="fl">1</span></span>
<span>      <span class="va">cv_corr</span><span class="op">[</span><span class="va">k</span>,<span class="va">m</span><span class="op">+</span><span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span>from<span class="op">=</span><span class="va">vettmin</span><span class="op">[</span><span class="va">n</span><span class="op">]</span>,</span>
<span>                            to<span class="op">=</span><span class="va">vettmax</span><span class="op">[</span><span class="va">n</span><span class="op">]</span>,</span>
<span>                            by<span class="op">=</span><span class="op">(</span><span class="va">vettmax</span><span class="op">[</span><span class="va">n</span><span class="op">]</span><span class="op">-</span><span class="va">vettmin</span><span class="op">[</span><span class="va">n</span><span class="op">]</span><span class="op">)</span><span class="op">/</span><span class="va">nvals</span><span class="op">)</span><span class="op">[</span><span class="va">solution</span><span class="op">[</span><span class="va">n</span><span class="op">]</span><span class="op">]</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">cv_corr</span></span>
<span>  <span class="va">a</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/beth1.html">beat.1st</a></span><span class="op">(</span><span class="va">strata</span>,<span class="va">cv_corr</span><span class="op">)</span></span>
<span>  <span class="va">b</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/ks.test.html" class="external-link">ks.test</a></span><span class="op">(</span><span class="va">a</span><span class="op">$</span><span class="va">alloc</span><span class="op">$</span><span class="va">ALLOC</span><span class="op">[</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">a</span><span class="op">$</span><span class="va">alloc</span><span class="op">)</span><span class="op">]</span>,<span class="va">a</span><span class="op">$</span><span class="va">alloc</span><span class="op">$</span><span class="va">PROP</span><span class="op">[</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">a</span><span class="op">$</span><span class="va">alloc</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">c</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">cor</a></span><span class="op">(</span><span class="va">a</span><span class="op">$</span><span class="va">alloc</span><span class="op">$</span><span class="va">ALLOC</span><span class="op">[</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">a</span><span class="op">$</span><span class="va">alloc</span><span class="op">)</span><span class="op">]</span>,<span class="va">a</span><span class="op">$</span><span class="va">alloc</span><span class="op">$</span><span class="va">PROP</span><span class="op">[</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">a</span><span class="op">$</span><span class="va">alloc</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="co">#---------- Fitness function ----------------</span></span>
<span>  <span class="va">fitness</span> <span class="op">&lt;-</span> <span class="va">c</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">fitness</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="setting-the-parameters">3.2 Setting the parameters<a class="anchor" aria-label="anchor" href="#setting-the-parameters"></a>
</h3>
<p>We set the parameters required by the QGA function:</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nvars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">cv_mod2</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span></span>
<span><span class="va">vett</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">k</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">cv_mod2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">vett</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">vett</span>,<span class="va">cv_mod2</span><span class="op">[</span><span class="va">k</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span><span class="op">:</span><span class="op">(</span><span class="va">nvars</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">vett</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="va">vett</span><span class="op">)</span></span>
<span><span class="va">vettmin</span> <span class="op">&lt;-</span> <span class="va">vett</span> <span class="op">*</span> <span class="fl">0.6</span></span>
<span><span class="va">vettmax</span> <span class="op">&lt;-</span> <span class="va">vett</span> <span class="op">*</span> <span class="fl">1.4</span></span>
<span><span class="va">Genome</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">vett</span><span class="op">)</span></span>
<span><span class="va">nvalues_sol</span> <span class="op">=</span> <span class="fl">4096</span>    <span class="co"># 2^12 ==&gt; 12 qubits</span></span>
<span><span class="va">eval_func_inputs</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">strata</span>,</span>
<span>                        <span class="va">vett</span>,</span>
<span>                        <span class="va">cv_mod2</span>,</span>
<span>                        <span class="va">vettmin</span>,</span>
<span>                        <span class="va">vettmax</span>,</span>
<span>                        <span class="va">nvalues_sol</span></span>
<span>                        <span class="op">)</span></span>
<span><span class="va">popsize</span> <span class="op">=</span> <span class="fl">20</span></span>
<span><span class="va">generation_max</span> <span class="op">=</span> <span class="fl">200</span></span>
<span><span class="va">nvalues_sol</span> <span class="op">=</span> <span class="va">nvalues_sol</span></span>
<span><span class="va">thetainit</span> <span class="op">=</span> <span class="fl">3.1415926535</span> <span class="op">*</span> <span class="fl">0.5</span></span>
<span><span class="va">thetaend</span> <span class="op">=</span> <span class="fl">3.1415926535</span> <span class="op">*</span> <span class="fl">0.025</span></span>
<span><span class="va">pop_mutation_rate_init</span> <span class="op">=</span> <span class="fl">1</span><span class="op">/</span><span class="op">(</span><span class="va">popsize</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">pop_mutation_rate_end</span> <span class="op">=</span> <span class="fl">1</span><span class="op">/</span><span class="op">(</span><span class="va">popsize</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">mutation_rate_init</span> <span class="op">=</span> <span class="fl">1</span><span class="op">/</span><span class="op">(</span><span class="va">Genome</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">mutation_rate_end</span> <span class="op">=</span> <span class="fl">1</span><span class="op">/</span><span class="op">(</span><span class="va">Genome</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">mutation_flag</span> <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="va">plotting</span> <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="va">verbose</span> <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="va">progress</span> <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="va">eval_fitness</span> <span class="op">=</span> <span class="va">fitness_cvs</span></span>
<span><span class="va">eval_func_inputs</span> <span class="op">=</span> <span class="va">eval_func_inputs</span></span>
<span><span class="va">stop_limit</span> <span class="op">=</span> <span class="fl">0.5</span></span></code></pre></div>
<p>Some explanations regarding the parameters. The parameters ‘vettmin’
and ‘vettmax’ are fundamental to determine the space of possible
solutions.</p>
<p>In fact, consider their values:</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">vettmin</span></span></code></pre></div>
<pre><code><span><span class="co">##         CV1         CV2         CV3         CV4         CV1         CV2 </span></span>
<span><span class="co">## 0.007753667 0.020390099 0.028535739 0.009765329 0.016794963 0.040812574 </span></span>
<span><span class="co">##         CV3         CV4         CV1         CV2         CV3         CV4 </span></span>
<span><span class="co">## 0.073886510 0.019315172 0.026217225 0.060745389 0.109570421 0.027768309</span></span></code></pre>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">vettmax</span></span></code></pre></div>
<pre><code><span><span class="co">##        CV1        CV2        CV3        CV4        CV1        CV2        CV3 </span></span>
<span><span class="co">## 0.01809189 0.04757690 0.06658339 0.02278577 0.03918825 0.09522934 0.17240186 </span></span>
<span><span class="co">##        CV4        CV1        CV2        CV3        CV4 </span></span>
<span><span class="co">## 0.04506873 0.06117352 0.14173924 0.25566432 0.06479272</span></span></code></pre>
<p>The values in vettmin are the minimum values that the CVs can assume,
while the values in vettmax are the maximum ones. This means that, for
instance, when trying to define the best value for CV1 in the first
domain, the genetic algorithm will search in the range from 0.007916888
to 0.01847274. The same for the other CVs and the other domains.</p>
<p>The parameter ‘nvalues_sol’ indicates the number of possible
different values considered for each element in the genome: by setting
it to 4096, it means that for each precision constraint, 4096 possible
values will be considered, the ones obtained by dividing by 4096 the
interval between the minimum and the maximum value set for each
precision constraint.</p>
<p>The parameter ‘eval_func_inputs’ is a list containing all the
information required by the fitness function.</p>
<p>Parameters ‘thetainit’ and ‘thetaend’ are the initial and final
values expressed in degrees for the rotation gate used in the quantum
genetic algorithm. The rotation is high at the beginning of the
iterations (to explore mores solutions), lower at the end (to refine the
best solution found).</p>
<p>The same for parameters from ‘pop_mutation_rate_init’ to
‘pop_mutation_rate_end’, that govern the rate of mutation in the
solutions.</p>
<p>Very important is the ‘stop_limit’ parameter: the iterations are
stopped when this limit is reached. In our case it is set to 0.5: this
means that when the correlation coefficient reaches this limit, the
algorithm stops and output the related solution.</p>
</div>
<div class="section level3">
<h3 id="execution-of-the-genetic-algorithm">3.3 Execution of the genetic algorithm<a class="anchor" aria-label="anchor" href="#execution-of-the-genetic-algorithm"></a>
</h3>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1234</span><span class="op">)</span></span>
<span><span class="va">solutionQGA</span> <span class="op">&lt;-</span> <span class="fu">QGA</span><span class="op">(</span><span class="va">popsize</span>,</span>
<span>                   <span class="va">generation_max</span>,</span>
<span>                   <span class="va">nvalues_sol</span>,</span>
<span>                   <span class="va">Genome</span>,</span>
<span>                   <span class="va">thetainit</span>,</span>
<span>                   <span class="va">thetaend</span>,</span>
<span>                   <span class="va">pop_mutation_rate_init</span>,</span>
<span>                   <span class="va">pop_mutation_rate_end</span>,</span>
<span>                   <span class="va">mutation_rate_init</span>,</span>
<span>                   <span class="va">mutation_rate_end</span>,</span>
<span>                   mutation_flag <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                   plotting <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                   verbose <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                   progress <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                   <span class="va">eval_fitness</span>,</span>
<span>                   <span class="va">eval_func_inputs</span>,</span>
<span>                   <span class="va">stop_limit</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">##  *** Best fitness:  0.5099748</span></span></code></pre>
<p><img src="CVs_optimization_files/figure-html/unnamed-chunk-17-1.png" width="700"></p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">QGA</span><span class="fu">:::</span><span class="fu">plot_Output</span><span class="op">(</span><span class="va">solutionQGA</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<p>So, we have obtained a solution whose correlation coefficient is 0.5,
the desired one.</p>
</div>
</div>
<div class="section level2">
<h2 id="analysis-of-the-final-solution">4. Analysis of the final solution<a class="anchor" aria-label="anchor" href="#analysis-of-the-final-solution"></a>
</h2>
<p>First, we consider the new set of precision constraints related to
the solution proposed by the genetic algorithm:</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">solution</span> <span class="op">&lt;-</span> <span class="va">solutionQGA</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="va">cv_best</span> <span class="op">&lt;-</span> <span class="va">cv_mod2</span></span>
<span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span><span class="va">nvals</span> <span class="op">&lt;-</span> <span class="va">nvalues_sol</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">k</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">cv_mod2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">m</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">nvars</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">n</span> <span class="op">&lt;-</span> <span class="va">n</span><span class="op">+</span><span class="fl">1</span></span>
<span>    <span class="va">diff</span></span>
<span>    <span class="va">cv_best</span><span class="op">[</span><span class="va">k</span>,<span class="va">m</span><span class="op">+</span><span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span>from<span class="op">=</span><span class="va">vettmin</span><span class="op">[</span><span class="va">n</span><span class="op">]</span>,</span>
<span>                          to<span class="op">=</span><span class="va">vettmax</span><span class="op">[</span><span class="va">n</span><span class="op">]</span>,</span>
<span>                          by<span class="op">=</span><span class="op">(</span><span class="va">vettmax</span><span class="op">[</span><span class="va">n</span><span class="op">]</span><span class="op">-</span><span class="va">vettmin</span><span class="op">[</span><span class="va">n</span><span class="op">]</span><span class="op">)</span><span class="op">/</span><span class="va">nvals</span><span class="op">)</span><span class="op">[</span><span class="va">solution</span><span class="op">[</span><span class="va">n</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span><span class="va">cv_best</span></span></code></pre></div>
<pre><code><span><span class="co">##    DOM         CV1        CV2        CV3        CV4</span></span>
<span><span class="co">## 1 DOM1 0.007766286 0.04269841 0.02931601 0.02277941</span></span>
<span><span class="co">## 2 DOM2 0.033376709 0.05598444 0.10041542 0.02157238</span></span>
<span><span class="co">## 3 DOM3 0.060516387 0.13693418 0.25327460 0.06462098</span></span></code></pre>
<p>They are, in some cases, higher than the initial ones.</p>
<p>But consider that, now, the required sample size is lower with these
new constraints:</p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">intermediate3</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/beth1.html">beat.1st</a></span><span class="op">(</span><span class="va">strata</span>,<span class="va">cv_best</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">intermediate3</span><span class="op">$</span><span class="va">alloc</span><span class="op">$</span><span class="va">ALLOC</span><span class="op">[</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">intermediate3</span><span class="op">$</span><span class="va">alloc</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 10398</span></span></code></pre>
<p>Also in this case, to compare the new precision constraints with the
initial ones we perform an adjustment, varying the new set until we
reach the previous sample size:</p>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">target_size</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">intermediate2</span><span class="op">$</span><span class="va">alloc</span><span class="op">$</span><span class="va">ALLOC</span><span class="op">[</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">intermediate2</span><span class="op">$</span><span class="va">alloc</span><span class="op">)</span><span class="op">]</span><span class="op">)</span> </span>
<span><span class="va">cv_final</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/adjust_CVs.html">adjust_CVs</a></span><span class="op">(</span>target_size <span class="op">=</span> <span class="va">target_size</span>,</span>
<span>                   strata<span class="op">=</span><span class="va">strata</span>,</span>
<span>                   errors<span class="op">=</span><span class="va">cv_best</span>,</span>
<span>                   adj_rate <span class="op">=</span> <span class="fl">0.05</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">##  Size:  11507</span></span>
<span><span class="co">##  Size:  12738</span></span>
<span><span class="co">##  Size:  14096</span></span>
<span><span class="co">##  Size:  15597</span></span>
<span><span class="co">##  Size:  17256</span></span>
<span><span class="co">##  Size:  19091</span></span>
<span><span class="co">##  Size:  19091</span></span></code></pre>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cv_final</span></span></code></pre></div>
<pre><code><span><span class="co">##    DOM         CV1        CV2        CV3        CV4</span></span>
<span><span class="co">## 1 DOM1 0.005708934 0.03138725 0.02154996 0.01674496</span></span>
<span><span class="co">## 2 DOM2 0.024534948 0.04115370 0.07381456 0.01585768</span></span>
<span><span class="co">## 3 DOM3 0.044485106 0.10065921 0.18618010 0.04750236</span></span></code></pre>
<p>It can be seen that now, only in the third domain level the value of
CV3 overcomes the previous limits, while in all the other cases they are
well below.</p>
<p>We can visualize the overall situation:</p>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">cv_final</span><span class="op">[</span><span class="fl">1</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>,col<span class="op">=</span><span class="st">"red"</span>,type<span class="op">=</span><span class="st">"b"</span>,</span>
<span>     xaxt<span class="op">=</span><span class="st">"n"</span>,xlab<span class="op">=</span><span class="st">""</span>,ylab<span class="op">=</span><span class="st">"CV values"</span>,ylim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">cv_final</span><span class="op">[</span><span class="fl">1</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span><span class="op">]</span>,<span class="va">cv_mod2</span><span class="op">[</span><span class="fl">1</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span><span class="op">]</span><span class="op">)</span><span class="op">*</span><span class="fl">1.2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/axis.html" class="external-link">axis</a></span><span class="op">(</span><span class="fl">1</span>, at<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">)</span>, lab<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"CV1"</span>, <span class="st">"CV2"</span>, <span class="st">"CV3"</span>, <span class="st">"CV4"</span><span class="op">)</span>,las<span class="op">=</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">cv_mod2</span><span class="op">[</span><span class="fl">1</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>,col<span class="op">=</span><span class="st">"blue"</span>,type<span class="op">=</span><span class="st">"b"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">cv_equal</span><span class="op">[</span><span class="fl">1</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>,col<span class="op">=</span><span class="st">"darkgreen"</span>,type<span class="op">=</span><span class="st">"b"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/title.html" class="external-link">title</a></span><span class="op">(</span><span class="st">"Domain level DOM1"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/legend.html" class="external-link">legend</a></span><span class="op">(</span><span class="st">"bottomleft"</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Initial CVs"</span>,<span class="st">"Intermediate CVs"</span>,<span class="st">"Final CVs"</span><span class="op">)</span>, </span>
<span>       fill <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"darkgreen"</span>,<span class="st">"blue"</span>,<span class="st">"red"</span><span class="op">)</span>, cex<span class="op">=</span><span class="fl">0.8</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">cv_final</span><span class="op">[</span><span class="fl">2</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>,col<span class="op">=</span><span class="st">"red"</span>,type<span class="op">=</span><span class="st">"b"</span>,</span>
<span>     xaxt<span class="op">=</span><span class="st">"n"</span>,xlab<span class="op">=</span><span class="st">""</span>,ylab<span class="op">=</span><span class="st">"CV values"</span>,ylim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">cv_final</span><span class="op">[</span><span class="fl">2</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span><span class="op">]</span>,<span class="va">cv_mod2</span><span class="op">[</span><span class="fl">2</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span><span class="op">]</span><span class="op">)</span><span class="op">*</span><span class="fl">1.2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/axis.html" class="external-link">axis</a></span><span class="op">(</span><span class="fl">1</span>, at<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">)</span>, lab<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"CV1"</span>, <span class="st">"CV2"</span>, <span class="st">"CV3"</span>, <span class="st">"CV4"</span><span class="op">)</span>,las<span class="op">=</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">cv_mod2</span><span class="op">[</span><span class="fl">2</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>,col<span class="op">=</span><span class="st">"blue"</span>,type<span class="op">=</span><span class="st">"b"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">cv_equal</span><span class="op">[</span><span class="fl">2</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>,col<span class="op">=</span><span class="st">"darkgreen"</span>,type<span class="op">=</span><span class="st">"b"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/title.html" class="external-link">title</a></span><span class="op">(</span><span class="st">"Domain level DOM2"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/legend.html" class="external-link">legend</a></span><span class="op">(</span><span class="st">"bottomleft"</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Initial CVs"</span>,<span class="st">"Intermediate CVs"</span>,<span class="st">"Final CVs"</span><span class="op">)</span>, </span>
<span>       fill <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"darkgreen"</span>,<span class="st">"blue"</span>,<span class="st">"red"</span><span class="op">)</span>, cex<span class="op">=</span><span class="fl">0.8</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># De-comment with 3 domains</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">cv_final</span><span class="op">[</span><span class="fl">3</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>,col<span class="op">=</span><span class="st">"red"</span>,type<span class="op">=</span><span class="st">"b"</span>,</span>
<span>     xaxt<span class="op">=</span><span class="st">"n"</span>,xlab<span class="op">=</span><span class="st">""</span>,ylab<span class="op">=</span><span class="st">"CV values"</span>,ylim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">cv_final</span><span class="op">[</span><span class="fl">3</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span><span class="op">]</span>,<span class="va">cv_mod2</span><span class="op">[</span><span class="fl">3</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span><span class="op">]</span><span class="op">)</span><span class="op">*</span><span class="fl">1.2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/axis.html" class="external-link">axis</a></span><span class="op">(</span><span class="fl">1</span>, at<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">)</span>, lab<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"CV1"</span>, <span class="st">"CV2"</span>, <span class="st">"CV3"</span>, <span class="st">"CV4"</span><span class="op">)</span>,las<span class="op">=</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">cv_mod2</span><span class="op">[</span><span class="fl">3</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>,col<span class="op">=</span><span class="st">"blue"</span>,type<span class="op">=</span><span class="st">"b"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">cv_equal</span><span class="op">[</span><span class="fl">3</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>,col<span class="op">=</span><span class="st">"darkgreen"</span>,type<span class="op">=</span><span class="st">"b"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/title.html" class="external-link">title</a></span><span class="op">(</span><span class="st">"Domain level DOM3"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/legend.html" class="external-link">legend</a></span><span class="op">(</span><span class="st">"bottomleft"</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Initial CVs"</span>,<span class="st">"Intermediate CVs"</span>,<span class="st">"Final CVs"</span><span class="op">)</span>, </span>
<span>       fill <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"darkgreen"</span>,<span class="st">"blue"</span>,<span class="st">"red"</span><span class="op">)</span>, cex<span class="op">=</span><span class="fl">0.8</span><span class="op">)</span></span></code></pre></div>
<p><img src="CVs_optimization_files/figure-html/unnamed-chunk-21-1.png" width="700"></p>
<p>Finally, we analyze the obtained final allocation in the strata.</p>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">final</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/beth1.html">beat.1st</a></span><span class="op">(</span><span class="va">strata</span>,<span class="va">cv_final</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">final</span><span class="op">$</span><span class="va">alloc</span><span class="op">$</span><span class="va">ALLOC</span><span class="op">[</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">final</span><span class="op">$</span><span class="va">alloc</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 19091</span></span></code></pre>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">equal</span><span class="op">$</span><span class="va">alloc</span><span class="op">$</span><span class="va">ALLOC</span><span class="op">[</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">equal</span><span class="op">$</span><span class="va">alloc</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 16973</span></span></code></pre>
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">a1</span> <span class="op">&lt;-</span> <span class="va">equal</span><span class="op">$</span><span class="va">alloc</span><span class="op">$</span><span class="va">ALLOC</span><span class="op">[</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">equal</span><span class="op">$</span><span class="va">alloc</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">a2</span> <span class="op">&lt;-</span> <span class="va">equal</span><span class="op">$</span><span class="va">alloc</span><span class="op">$</span><span class="va">PROP</span><span class="op">[</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">equal</span><span class="op">$</span><span class="va">alloc</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">b1</span> <span class="op">&lt;-</span> <span class="va">final</span><span class="op">$</span><span class="va">alloc</span><span class="op">$</span><span class="va">ALLOC</span><span class="op">[</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">final</span><span class="op">$</span><span class="va">alloc</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">b2</span> <span class="op">&lt;-</span> <span class="va">final</span><span class="op">$</span><span class="va">alloc</span><span class="op">$</span><span class="va">PROP</span><span class="op">[</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">final</span><span class="op">$</span><span class="va">alloc</span><span class="op">)</span><span class="op">]</span></span></code></pre></div>
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">top</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">a1</span>,<span class="va">a2</span>,<span class="va">b1</span>,<span class="va">b2</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">a1</span>,type<span class="op">=</span><span class="st">"b"</span>,col<span class="op">=</span><span class="st">"blue"</span>,ylim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="va">top</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">a2</span>,type<span class="op">=</span><span class="st">"h"</span>,col<span class="op">=</span><span class="st">"red"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/title.html" class="external-link">title</a></span><span class="op">(</span><span class="st">"Initial"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/legend.html" class="external-link">legend</a></span><span class="op">(</span><span class="st">"topright"</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Proportional"</span>,<span class="st">"Optimal"</span><span class="op">)</span>, fill <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"red"</span>, <span class="st">"blue"</span><span class="op">)</span>, cex<span class="op">=</span><span class="fl">0.8</span><span class="op">)</span></span></code></pre></div>
<p><img src="CVs_optimization_files/figure-html/unnamed-chunk-23-1.png" width="700"></p>
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">b1</span>,type<span class="op">=</span><span class="st">"b"</span>,col<span class="op">=</span><span class="st">"blue"</span>,ylim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="va">top</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">b2</span>,type<span class="op">=</span><span class="st">"h"</span>,col<span class="op">=</span><span class="st">"red"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/title.html" class="external-link">title</a></span><span class="op">(</span><span class="st">"Final"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/legend.html" class="external-link">legend</a></span><span class="op">(</span><span class="st">"topright"</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Proportional"</span>,<span class="st">"Optimal"</span><span class="op">)</span>, fill <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"red"</span>, <span class="st">"blue"</span><span class="op">)</span>, cex<span class="op">=</span><span class="fl">0.8</span><span class="op">)</span></span></code></pre></div>
<p><img src="CVs_optimization_files/figure-html/unnamed-chunk-23-2.png" width="700"></p>
<p>We may not be satisfied by the situation in the 22nd and 24th
sub-domains where the new solution yields a greater distance of the
optimal allocations from the proportional ones.</p>
<p>We inspect the sensitivity:</p>
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">final</span><span class="op">$</span><span class="va">sensitivity</span><span class="op">[</span><span class="va">final</span><span class="op">$</span><span class="va">sensitivity</span><span class="op">$</span><span class="va">Dom</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">22</span>,<span class="fl">24</span><span class="op">)</span>,<span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">##     Type Dom Var Planned CV Actual CV Sensitivity 10%</span></span>
<span><span class="co">## 102 DOM3  22  V1 0.04448511    0.0340               1</span></span>
<span><span class="co">## 103 DOM3  22  V2 0.10065921    0.0553               1</span></span>
<span><span class="co">## 104 DOM3  22  V3 0.18618010    0.0329               0</span></span>
<span><span class="co">## 105 DOM3  22  V4 0.04750236    0.0475             251</span></span>
<span><span class="co">## 110 DOM3  24  V1 0.04448511    0.0445             199</span></span>
<span><span class="co">## 111 DOM3  24  V2 0.10065921    0.0504               1</span></span>
<span><span class="co">## 112 DOM3  24  V3 0.18618010    0.0352               0</span></span>
<span><span class="co">## 113 DOM3  24  V4 0.04750236    0.0227               1</span></span></code></pre>
<p>and find that the reason for the oversampling in these two domains is
due to the 1st and 4th target variables. We can change their CVs in the
3rd domain level:</p>
<div class="sourceCode" id="cb53"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cv_final</span><span class="op">[</span><span class="fl">3</span>,<span class="fl">2</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0.10</span></span>
<span><span class="va">cv_final</span><span class="op">[</span><span class="fl">3</span>,<span class="fl">5</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0.10</span></span></code></pre></div>
<p>and verify the new situation:</p>
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">final2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/beth1.html">beat.1st</a></span><span class="op">(</span><span class="va">strata</span>,<span class="va">cv_final</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">final2</span><span class="op">$</span><span class="va">alloc</span><span class="op">$</span><span class="va">ALLOC</span><span class="op">[</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">final2</span><span class="op">$</span><span class="va">alloc</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 17091</span></span></code></pre>
<div class="sourceCode" id="cb56"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">b1</span> <span class="op">&lt;-</span> <span class="va">final2</span><span class="op">$</span><span class="va">alloc</span><span class="op">$</span><span class="va">ALLOC</span><span class="op">[</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">final2</span><span class="op">$</span><span class="va">alloc</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">b2</span> <span class="op">&lt;-</span> <span class="va">final2</span><span class="op">$</span><span class="va">alloc</span><span class="op">$</span><span class="va">PROP</span><span class="op">[</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">final2</span><span class="op">$</span><span class="va">alloc</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">b1</span>,type<span class="op">=</span><span class="st">"b"</span>,col<span class="op">=</span><span class="st">"blue"</span>,ylim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="va">top</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">b2</span>,type<span class="op">=</span><span class="st">"h"</span>,col<span class="op">=</span><span class="st">"red"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/title.html" class="external-link">title</a></span><span class="op">(</span><span class="st">"Final"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/legend.html" class="external-link">legend</a></span><span class="op">(</span><span class="st">"topright"</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Proportional"</span>,<span class="st">"Optimal"</span><span class="op">)</span>, fill <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"red"</span>, <span class="st">"blue"</span><span class="op">)</span>, cex<span class="op">=</span><span class="fl">0.8</span><span class="op">)</span></span></code></pre></div>
<p><img src="CVs_optimization_files/figure-html/unnamed-chunk-26-1.png" width="700"></p>
<p>Much better.</p>
<p>Again, we re-determine the CVs in order to reach the initial sample
size:</p>
<div class="sourceCode" id="cb57"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">target_size</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">final</span><span class="op">$</span><span class="va">alloc</span><span class="op">$</span><span class="va">ALLOC</span><span class="op">[</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">final</span><span class="op">$</span><span class="va">alloc</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">cv_final2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/adjust_CVs.html">adjust_CVs</a></span><span class="op">(</span>target_size<span class="op">=</span> <span class="va">target_size</span>,</span>
<span>                   strata<span class="op">=</span><span class="va">strata</span>,</span>
<span>                   errors<span class="op">=</span><span class="va">cv_final</span>,</span>
<span>                   adj_rate<span class="op">=</span><span class="fl">0.05</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">##  Size:  18916</span></span>
<span><span class="co">##  Size:  20933</span></span>
<span><span class="co">##  Size:  20933</span></span></code></pre>
<div class="sourceCode" id="cb59"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cv_final2</span></span></code></pre></div>
<pre><code><span><span class="co">##    DOM         CV1        CV2        CV3        CV4</span></span>
<span><span class="co">## 1 DOM1 0.005152313 0.02832700 0.01944884 0.01511233</span></span>
<span><span class="co">## 2 DOM2 0.022142790 0.03714122 0.06661764 0.01431156</span></span>
<span><span class="co">## 3 DOM3 0.090250000 0.09084494 0.16802754 0.09025000</span></span></code></pre>
<div class="sourceCode" id="cb61"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">cv_final2</span><span class="op">[</span><span class="fl">3</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>,col<span class="op">=</span><span class="st">"red"</span>,type<span class="op">=</span><span class="st">"b"</span>,</span>
<span>     xaxt<span class="op">=</span><span class="st">"n"</span>,xlab<span class="op">=</span><span class="st">""</span>,ylab<span class="op">=</span><span class="st">"CV values"</span>,ylim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">cv_final2</span><span class="op">[</span><span class="fl">3</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span><span class="op">]</span>,<span class="va">cv_mod2</span><span class="op">[</span><span class="fl">3</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span><span class="op">]</span><span class="op">)</span><span class="op">*</span><span class="fl">1.2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/axis.html" class="external-link">axis</a></span><span class="op">(</span><span class="fl">1</span>, at<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">)</span>, lab<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"CV1"</span>, <span class="st">"CV2"</span>, <span class="st">"CV3"</span>, <span class="st">"CV4"</span><span class="op">)</span>,las<span class="op">=</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">cv_mod2</span><span class="op">[</span><span class="fl">3</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>,col<span class="op">=</span><span class="st">"blue"</span>,type<span class="op">=</span><span class="st">"b"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">cv_equal</span><span class="op">[</span><span class="fl">3</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>,col<span class="op">=</span><span class="st">"darkgreen"</span>,type<span class="op">=</span><span class="st">"b"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/title.html" class="external-link">title</a></span><span class="op">(</span><span class="st">"Domain level DOM3"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/legend.html" class="external-link">legend</a></span><span class="op">(</span><span class="st">"topleft"</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Initial CVs"</span>,<span class="st">"Intermediate CVs"</span>,<span class="st">"Final CVs"</span><span class="op">)</span>, </span>
<span>       fill <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"darkgreen"</span>,<span class="st">"blue"</span>,<span class="st">"red"</span><span class="op">)</span>, cex<span class="op">=</span><span class="fl">0.8</span><span class="op">)</span></span></code></pre></div>
<p><img src="CVs_optimization_files/figure-html/unnamed-chunk-28-1.png" width="700"></p>
<p>Finally, we analyze the changes in the expected CVs:</p>
<div class="sourceCode" id="cb62"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">a</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/beat.1cv.html">beat.1cv</a></span><span class="op">(</span><span class="va">strata</span>,<span class="va">cv_equal</span>,<span class="va">equal</span><span class="op">$</span><span class="va">alloc</span><span class="op">$</span><span class="va">ALLOC</span><span class="op">)</span></span>
<span><span class="va">b</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/beat.1cv.html">beat.1cv</a></span><span class="op">(</span><span class="va">strata</span>,<span class="va">cv_mod2</span>,<span class="va">intermediate2</span><span class="op">$</span><span class="va">alloc</span><span class="op">$</span><span class="va">ALLOC</span><span class="op">)</span></span>
<span><span class="va">c</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/beat.1cv.html">beat.1cv</a></span><span class="op">(</span><span class="va">strata</span>,<span class="va">cv_final2</span>,<span class="va">final</span><span class="op">$</span><span class="va">alloc</span><span class="op">$</span><span class="va">ALLOC</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/row.names.html" class="external-link">row.names</a></span><span class="op">(</span><span class="va">a</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span><span class="va">tot</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">a</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span>,<span class="fl">4</span><span class="op">)</span><span class="op">]</span>,<span class="va">b</span><span class="op">[</span>,<span class="fl">4</span><span class="op">]</span>,<span class="va">c</span><span class="op">[</span>,<span class="fl">4</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">tot</span><span class="op">)</span><span class="op">[</span><span class="fl">3</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Initial(1)"</span>,<span class="st">"Intermediate(2)"</span>,<span class="st">"Final(3)"</span><span class="op">)</span></span>
<span><span class="va">tot</span><span class="op">$</span><span class="va">Diff1</span> <span class="op">&lt;-</span> <span class="va">tot</span><span class="op">$</span><span class="va">`Intermediate(2)`</span><span class="op">-</span> <span class="va">tot</span><span class="op">$</span><span class="va">`Initial(1)`</span></span>
<span><span class="va">tot</span><span class="op">$</span><span class="va">Diff2</span> <span class="op">&lt;-</span> <span class="va">tot</span><span class="op">$</span><span class="va">`Final(3)`</span><span class="op">-</span> <span class="va">tot</span><span class="op">$</span><span class="va">`Intermediate(2)`</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">tot</span><span class="op">)</span><span class="op">[</span><span class="fl">6</span><span class="op">:</span><span class="fl">7</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Diff.(2-1)"</span>,<span class="st">"Diff.(3-2)"</span><span class="op">)</span></span>
<span><span class="co"># knitr::kable(tot)</span></span></code></pre></div>
<p>The average change due to the first step (balancing the influence of
all variables in the determination of the best allocation):</p>
<div class="sourceCode" id="cb63"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">tot</span><span class="op">$</span><span class="va">`Diff.(2-1)`</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">tot</span><span class="op">$</span><span class="va">Initial</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] -0.3774151</span></span></code></pre>
<p>and the average change due to the second step (bringing the opimal
allocation closer to the proportional):</p>
<div class="sourceCode" id="cb65"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">tot</span><span class="op">$</span><span class="va">`Diff.(3-2)`</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">tot</span><span class="op">$</span><span class="va">Initial</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 0.07574547</span></span></code></pre>
<p>We can calculate the same indicators by weighting with the
populations in the domains:</p>
<div class="sourceCode" id="cb67"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># tot$DOMAIN &lt;-  sub("/.*", "", tot$`DOMAIN/VAR`) </span></span>
<span><span class="va">dom1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/aggregate.html" class="external-link">aggregate</a></span><span class="op">(</span><span class="va">strata</span><span class="op">$</span><span class="va">N</span>,by<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">strata</span><span class="op">$</span><span class="va">DOM1</span><span class="op">)</span>,FUN<span class="op">=</span><span class="va">sum</span><span class="op">)</span></span>
<span><span class="va">dom2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/aggregate.html" class="external-link">aggregate</a></span><span class="op">(</span><span class="va">strata</span><span class="op">$</span><span class="va">N</span>,by<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">strata</span><span class="op">$</span><span class="va">DOM2</span><span class="op">)</span>,FUN<span class="op">=</span><span class="va">sum</span><span class="op">)</span></span>
<span><span class="va">dom3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/aggregate.html" class="external-link">aggregate</a></span><span class="op">(</span><span class="va">strata</span><span class="op">$</span><span class="va">N</span>,by<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">strata</span><span class="op">$</span><span class="va">DOM3</span><span class="op">)</span>,FUN<span class="op">=</span><span class="va">sum</span><span class="op">)</span></span>
<span><span class="va">tot1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/merge.html" class="external-link">merge</a></span><span class="op">(</span><span class="va">tot</span>,<span class="va">dom1</span>,by.x<span class="op">=</span><span class="st">"DOMAIN"</span>,by.y<span class="op">=</span><span class="st">"Group.1"</span><span class="op">)</span></span>
<span><span class="va">tot2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/merge.html" class="external-link">merge</a></span><span class="op">(</span><span class="va">tot</span>,<span class="va">dom2</span>,by.x<span class="op">=</span><span class="st">"DOMAIN"</span>,by.y<span class="op">=</span><span class="st">"Group.1"</span><span class="op">)</span></span>
<span><span class="va">tot3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/merge.html" class="external-link">merge</a></span><span class="op">(</span><span class="va">tot</span>,<span class="va">dom3</span>,by.x<span class="op">=</span><span class="st">"DOMAIN"</span>,by.y<span class="op">=</span><span class="st">"Group.1"</span><span class="op">)</span></span>
<span><span class="va">tottot</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">tot1</span>,<span class="va">tot2</span>,<span class="va">tot3</span><span class="op">)</span></span>
<span></span>
<span><span class="va">AvgInitial</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">tottot</span><span class="op">$</span><span class="va">`Initial(1)`</span> <span class="op">*</span> <span class="va">tottot</span><span class="op">$</span><span class="va">x</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">tottot</span><span class="op">$</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="va">AvgDiff2_1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">tottot</span><span class="op">$</span><span class="va">`Diff.(2-1)`</span> <span class="op">*</span> <span class="va">tottot</span><span class="op">$</span><span class="va">x</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">tottot</span><span class="op">$</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="va">AvgDiff2_1</span> <span class="op">/</span> <span class="va">AvgInitial</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] -0.3867286</span></span></code></pre>
<div class="sourceCode" id="cb69"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">AvgDiff3_2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">tottot</span><span class="op">$</span><span class="va">`Diff.(3-2)`</span> <span class="op">*</span> <span class="va">tottot</span><span class="op">$</span><span class="va">x</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">tottot</span><span class="op">$</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="va">AvgDiff3_2</span> <span class="op">/</span> <span class="va">AvgInitial</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] -0.07358291</span></span></code></pre>
<p>We can conclude that the first step has a strong impact on the values
of the expected CVs, while the second step is negligible from this point
of view.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Andrea Fasulo, Giulio Barcaroli, Stefano Falorsi, Alessio Guandalini, Ilaria Bombelli, Marco Dionisio Terribili.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

      </footer>
</div>






  </body>
</html>
